<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🪔MovieFlix🪔</title>
    
    <!-- FONT AWESOME CDN - YEH ADD KIYA HAI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Plyr.js CSS for modern player UI -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <!-- Swiper.js CSS for the Featured Carousel -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root {
            --primary-bg: #1f212a;
            --secondary-bg: #121212;
            --text-primary: #fff;
            --text-secondary: #a9a9a9;
            --accent-color: #0092ff;
            --netflix-red: #E50914;
            --plyr-color-main: var(--netflix-red);
            --swiper-theme-color: var(--netflix-red);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--secondary-bg); 
            color: var(--text-primary); 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
            touch-action: pan-y;
        }
        
        .page { display: none; animation: fadeIn 0.5s ease-in-out; min-height: 100vh; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--netflix-red);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            background-color: var(--primary-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .skeleton-poster {
            width: 100%;
            height: 160px;
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        .skeleton-text {
            height: 12px;
            margin: 8px;
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        
        /* Network Status */
        .network-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff4444;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .network-status.show {
            display: block;
            transform: translateY(0);
        }
        
        .network-status.online {
            background: #4CAF50;
        }
        
        /* Error State */
        .error-container {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--netflix-red);
        }
        
        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .retry-button {
            background: var(--netflix-red);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .retry-button:hover {
            background: #ff0a16;
        }
        
        /* Lazy Loading Images */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .lazy-image.loaded {
            opacity: 1;
        }
        
        /* Improved Mobile Touch */
        .content-card, .tv-card, .episode-card {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-perspective: 1000;
            perspective: 1000;
        }
        
        /* Progress Bar for Loading */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--netflix-red);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
            z-index: 10001;
        }
        
        .progress-bar.active {
            transform: scaleX(0.5);
            animation: progress 2s ease-in-out infinite;
        }
        
        @keyframes progress {
            0% { transform: scaleX(0); }
            50% { transform: scaleX(0.7); }
            100% { transform: scaleX(1); }
        }

        /* Search History Styles */
        .search-history-item {
            background-color: var(--primary-bg);
            border-radius: 20px;
            padding: 8px 15px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        
        .search-history-item:hover {
            background-color: var(--accent-color);
        }

        .search-history-item i {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .search-history-item-delete {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.7;
        }

        .search-history-item-delete:hover {
            opacity: 1;
        }

        /* Enhanced Search Suggestions */
        .search-suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #333;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .search-suggestions-container.active {
            display: block;
        }

        .search-suggestion-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-suggestion-item:hover {
            background-color: #444;
        }

        .search-suggestion-item.active {
            background-color: var(--accent-color);
        }

        .search-suggestion-poster {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .search-suggestion-info {
            flex: 1;
            min-width: 0;
        }

        .search-suggestion-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-suggestion-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-suggestion-highlight {
            color: var(--netflix-red);
            font-weight: bold;
        }

        .search-no-results {
            padding: 15px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* --- Auth & Splash Styles --- */
        #authContainer { background: url('https://assets.nflxext.com/ffe/siteui/vlv3/9c5457b8-9ab0-4a04-9fc1-e608d5670f1a/710d74e0-7158-408e-8d9b-23c219dee5df/IN-en-20210719-popsignuptwoweeks-perspective_alpha_website_large.jpg') no-repeat center; background-size: cover; }
        .auth-overlay { background: rgba(0,0,0,0.7); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: rgba(0, 0, 0, 0.85); padding: 40px; border-radius: 8px; width: 100%; max-width: 400px; box-sizing: border-box; }
        .auth-form input { width: 100%; padding: 16px; margin-bottom: 20px; border-radius: 5px; border: none; background: #333; color: var(--text-primary); font-size: 1em; box-sizing: border-box; }
        .auth-form button { width: 100%; padding: 16px; border-radius: 5px; border: none; background: var(--netflix-red); color: var(--text-primary); font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; transition: background-color 0.2s; }
        .auth-form button:disabled { background-color: #99060d; cursor: wait; }
        #splashScreen { display: none; align-items: center; justify-content: center; background: #000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; }

        .splash-content .logo {
        font-size: 5em;
        font-weight: 900;
        background: linear-gradient(90deg, #00E1FF, #E900FF);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        }

        /* --- Welcome Popup Styles --- */
        .welcome-popup {
            position: fixed;
            top: 20px;
            left: -400px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--netflix-red);
            padding: 20px 25px;
            border-radius: 12px;
            z-index: 10000;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(229, 9, 20, 0.3);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 320px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .welcome-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #E50914, #ff5252, #E50914);
            background-size: 200% 100%;
            animation: gradientMove 2s linear infinite;
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .welcome-popup.show {
            left: 20px;
            transform: scale(1);
            animation: pulse 0.5s ease-out;
        }
        
        .welcome-popup.hide {
            left: -400px;
            transform: scale(0.8);
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .welcome-icon {
            font-size: 2em;
            margin-right: 15px;
            animation: bounce 1.5s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .welcome-text {
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .welcome-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--netflix-red);
            width: 100%;
            transform-origin: left;
            animation: progress 4s linear forwards;
        }
        
        @keyframes progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }
        
        .welcome-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background-color: var(--netflix-red);
            border-radius: 50%;
            opacity: 0.7;
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
        }

        /* --- Update Popup Styles --- */
        .update-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .update-popup.active {
            display: flex;
        }

        .update-popup-content {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .update-popup-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: var(--netflix-red);
        }

        .update-popup-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .update-popup-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .update-popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .update-popup-btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .update-popup-btn:hover {
            transform: scale(1.05);
        }

        .update-popup-btn.download {
            background-color: var(--netflix-red);
            color: white;
        }

        .update-popup-btn.later {
            background-color: #444;
            color: white;
        }

        .update-popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        /* --- Main App Wrapper & Header --- */
        #mainApp { padding-bottom: 120px; }
        #mainContent.homepage-padding { padding-top: 60px; }

        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: transparent; position: fixed; top: 0; left: 0; right: 0; z-index: 100; transition: background-color 0.3s; }
        .app-header.scrolled { background-color: #17181f; }

        .app-header .logo {
        font-size: 2.1em;
        font-weight: 900;
        text-shadow: none;
        background: linear-gradient(90deg, #00E1FF, #E900FF);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        }
        .app-header i { width: 24px; height: 24px; cursor: pointer; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }

        /* --- Side Menu --- */
        #menuOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1001; }
        #sideMenu { display: block; position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #1f212a; z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #sideMenu.open { transform: translateX(0); }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-secondary); cursor: pointer; }
        .menu-item.active { background-color: var(--accent-color); color: var(--text-primary); }
        .menu-profile { padding: 20px; text-align: center; border-bottom: 1px solid #333; }
        .menu-profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid var(--accent-color);
        }
        .menu-profile h3 { margin: 10px 0 0 0; font-size: 1em; font-weight: normal; word-break: break-all; }

        /* --- Featured Carousel Styles --- */
        .featured-carousel { 
            width: 100%; 
            height: 60vh; 
            min-height: 300px; 
            margin-bottom: 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .swiper-slide { 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            background-color: #000; 
            position: relative; 
            cursor: pointer; 
        }
        .featured-content { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            padding: 40px 20px; 
            background: linear-gradient(to top, rgba(18,18,18,1) 0%, rgba(18,18,18,0.8) 50%, rgba(18,18,18,0) 100%); 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
        }
        .featured-title { 
            font-size: 2.2em; 
            font-weight: bold; 
            margin: 0 0 10px 0; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); 
        }
        .featured-category { 
            color: var(--text-secondary); 
            font-size: 1em; 
            margin: 0; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); 
        }
        .swiper-pagination-bullet { 
            background: var(--text-secondary); 
            opacity: 0.5; 
        }
        .swiper-pagination-bullet-active { 
            background: var(--netflix-red); 
            opacity: 1; 
        }

        /* --- Content & Grid Styles --- */
        .page-content-wrapper { padding-top: 60px; }
        .page-title-bar { display: flex; align-items: center; gap: 15px; padding: 15px; }
        .page-title-bar h1 { font-size: 1.5em; margin: 0; }
        .category-row { margin-bottom: 25px; overflow: hidden; }
        .category-row-inner { padding-left: 15px; }
        .category-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-right: 15px; }
        .category-title-left { display: flex; align-items: center; gap: 8px; }
        .category-title-bar { width: 4px; height: 20px; background-color: var(--accent-color); border-radius: 2px; }
        .category-title h2 { font-size: 1.2em; margin: 0; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; padding: 0 15px; }
        .content-card { 
            background-color: var(--primary-bg); 
            border-radius: 8px; 
            overflow: hidden; 
            cursor: pointer; 
            transition: transform 0.2s; 
            width: 100%; 
            position: relative; 
        }
        .content-card:hover { transform: scale(1.05); }
        .content-card img { width: 100%; height: 160px; object-fit: cover; }
        .content-card-info { padding: 8px; }
        .content-card-title { font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* NEW: Rating and Badge Styles */
        .content-card-rating {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
            z-index: 10;
        }

        .rating-star {
            color: #FFD700;
            font-size: 0.9em;
        }

        .content-card-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: var(--netflix-red);
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 10;
        }

        .coming-soon-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            pointer-events: none;
        }
        .content-card.coming-soon {
            cursor: default;
        }
        .content-card.coming-soon:hover {
            transform: none;
        }

        .category-row .swiper-container { padding-left: 15px; }
        .category-row .swiper-slide { width: 120px; }

        /* --- Continue Watching Styles --- */
        .continue-watching-section {
        padding: 10px 15px 25px 15px;
        }
        .cw-card {
        background-color: var(--primary-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px;
        position: relative;
        overflow: hidden;
        }
        .cw-poster img {
        width: 70px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        flex-shrink: 0;
        }
        .cw-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
        }
        .cw-title {
        font-size: 1.1em;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        }
        .cw-subtitle {
        font-size: 0.9em;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        }
        .cw-progress-bar-background {
        width: 100%;
        height: 4px;
        background-color: #444;
        border-radius: 2px;
        margin-top: 5px;
        }
        .cw-progress-bar-foreground {
        height: 100%;
        background-color: var(--netflix-red);
        border-radius: 2px;
        }
        .cw-play-btn {
        background: none;
        border: 2px solid var(--text-primary);
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        }
        .cw-play-btn i {
        width: 24px;
        height: 24px;
        fill: var(--text-primary);
        margin-left: 3px;
        }

        /* --- Homepage Category Grid Styles --- */
        .category-grid-homepage {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        padding: 0 15px;
        }
        .category-card-homepage {
        position: relative;
        aspect-ratio: 16 / 9;
        background-size: cover;
        background-position: center;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        }
        .category-card-homepage::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.4);
        transition: background 0.3s;
        }
        .category-card-homepage:hover::after {
        background: rgba(0,0,0,0.6);
        }
        .category-card-homepage span {
        font-weight: bold;
        font-size: 1.1em;
        color: white;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        z-index: 2;
        }

        /* --- Search Overlay --- */
        #searchOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(18, 18, 18, 0.98); z-index: 2000; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        #searchOverlay.active { display: flex; }
        .search-overlay-header { display: flex; align-items: center; gap: 15px; }
        .search-bar-wrapper { position: relative; flex-grow: 1; }
        #overlaySearchInput { width: 100%; padding: 14px 14px 14px 45px; font-size: 1em; background: #333; border: 1px solid #444; border-radius: 8px; color: white; box-sizing: border-box; }
        .search-icon-svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; fill: var(--text-secondary); }
        .close-search-btn { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; }
        #overlaySearchResults { padding-top: 20px; }
        #overlaySearchResults.empty::after { content: 'No results found.'; display: block; text-align: center; color: var(--text-secondary); margin-top: 40px; font-size: 1.1em; }

        /* --- Detail Page & Player Styles --- */
        .detail-view-container {
            padding-top: 60px;
            padding-bottom: 20px; 
        }
        #player-container { width: 100%; background-size: cover; background-position: center; position: relative; }
   
        #player-container video { width: 100%; height: auto; aspect-ratio: 16 / 9; background: black; }
        .player-wrapper { position: relative; width: 100%; background-color: black; }
        .player-wrapper video, .player-wrapper .plyr { width: 100%; height: 100%; }
        .player-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 15;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: transparent;
            transition: opacity 0.3s ease;
        }

        .player-wrapper .player-header {
            opacity: 1 !important;
            pointer-events: all;
        }
        .player-back-btn { background: none; border: none; color: white; padding: 0; cursor: pointer; pointer-events: all; }
        .player-back-btn i { width: 24px; height: 24px; }
        .player-title { font-size: 1.1em; font-weight: bold; }

        .hero-content { display: flex; flex-direction: column; justify-content: flex-end; min-height: 45vh; padding: 20px; background: linear-gradient(to top, rgba(18,18,18,1), rgba(18,18,18,0.5) 50%, rgba(18,18,18,0)); box-sizing: border-box; padding-top: 70px; }
        .hero-content h1 { font-size: 2.5em; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .hero-content p { color: var(--text-secondary); margin: 5px 0 20px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .play-button-main { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; font-size: 1.2em; font-weight: bold; background-color: var(--netflix-red); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .detail-body-content { padding: 0 20px; }
        .detail-description { line-height: 1.6; color: var(--text-secondary); margin-top: 20px; }
        .actions-bar { display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: center; gap: 20px; margin-top: 20px; padding-bottom: 15px; }
        .detail-ad-container { min-width: 320px; display: flex; justify-content: center; margin-left: auto; }
        .action-buttons-container { display: flex; gap: 25px; }
        .action-btn { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em; }
        .action-btn:hover, .action-btn.active { color: var(--text-primary); }
        .action-btn span { font-size: 0.9em; }
        #episodes-section { margin-top: 25px; overflow: hidden; }
        .up-next-section { padding: 0; margin-top: 25px; }

        #episodes-section h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        #episodes-section h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background-color: var(--netflix-red);
            border-radius: 2px;
        }

        .episodes-swiper .swiper-slide {
            width: 160px;
        }
        .episode-card {
            background-color: var(--primary-bg);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            width: 100%;
        }

        .episode-card.playing-now {
            border: 3px solid var(--netflix-red);
            box-shadow: 0 0 15px rgba(229, 9, 20, 0.6);
            transform: scale(1.03);
        }
        .episode-card:hover {
            transform: scale(1.05);
        }
        .episode-card-poster {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #333;
        }
        .episode-card-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .episode-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .episode-play-icon i {
            width: 20px;
            height: 20px;
            fill: white;
            margin-left: 2px;
        }
        .episode-card-title {
            padding: 8px 10px;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Live TV --- */
        .tv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 0 15px; }
        .tv-card { background-color: var(--primary-bg); border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .tv-card:hover { transform: scale(1.05); }
        .tv-card img { width: 100%; height: 80px; object-fit: contain; }
        .tv-card-title { margin-top: 8px; font-size: 0.9em; }

        /* --- Discuss / Chat Page --- */
        .discuss-page-container { display: flex; flex-direction: column; position: fixed; top: 60px; bottom: 60px; left: 0; right: 0; width: 100%; box-sizing: border-box; }
        .messages-container { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .message-wrapper { display: flex; margin-bottom: 10px; position: relative; }
        .message-item { background-color: #2a2c34; padding: 10px 15px; border-radius: 18px; max-width: 75%; word-wrap: break-word; }
        .message-item .sender { font-weight: bold; color: var(--text-secondary); font-size: 0.8em; margin-bottom: 4px; }
        .message-wrapper.own-message { justify-content: flex-end; }
        .message-wrapper.own-message .message-item { background-color: var(--accent-color); }
        .message-wrapper.own-message .sender { color: rgba(255, 255, 255, 0.8); }
        .message-form-container { display: flex; padding: 10px; border-top: 1px solid #333; background-color: #1f212a; }
        #messageInput { flex-grow: 1; padding: 12px; background-color: #333; border: 1px solid #444; border-radius: 20px; color: white; font-size: 1em; border: none; }
        #messageForm button { background: var(--netflix-red); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; margin-left: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }
        .message-wrapper.own-message .message-avatar {
            margin-left: 8px;
            margin-right: 0;
            order: 2;
        }
        .message-content {
            display: flex;
            flex-direction: column;
        }
        .message-wrapper.own-message .message-content {
            align-items: flex-end;
        }

        .message-options {
            position: absolute;
            top: -40px;
            right: 10px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 100;
            overflow: hidden;
        }
        .message-options.active {
            display: block;
        }
        .message-option {
            padding: 8px 15px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .message-option:hover {
            background-color: #444;
        }
        .message-option i {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .message-option.edit {
            color: #4CAF50;
        }
        .message-option.delete {
            color: #F44336;
        }
        
        .edit-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .edit-message-modal.active {
            display: flex;
        }
        .edit-message-container {
            background-color: var(--primary-bg);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }
        .edit-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .edit-message-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        .edit-message-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        .edit-message-input {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .edit-message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .edit-message-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .edit-message-cancel {
            background-color: #555;
            color: white;
        }
        .edit-message-save {
            background-color: var(--netflix-red);
            color: white;
        }

        /* --- Donation Page Styles --- */
        .donation-container { padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 25px; }
        .donation-reasons { border: 1px solid #444; border-radius: 8px; padding: 10px 20px; max-width: 350px; width: 90%; }
        .donation-reasons p { margin: 10px 0; text-align: left; }
        .donation-qr h3 { margin-top: 0; margin-bottom: 10px; font-weight: normal; color: var(--text-secondary); }
        .donation-form { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 20px; }
        .amount-input-wrapper { background-color: #fff; color: #000; border-radius: 8px; padding: 15px; display: flex; align-items: center; }
        .amount-input-wrapper label { font-weight: bold; }
        #donationAmount { border: none; background: transparent; color: #000; font-size: 1em; width: 100%; outline: none; }
        .donate-button { background-color: #008080; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
        .upi-toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(30, 30, 30, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9em; z-index: 9999; }

        /* --- Bottom Nav --- */
        #bottomNav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: #101116; border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #8e8e8e; cursor: pointer; gap: 4px; flex: 1; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item i { width: 24px; height: 24px; fill: currentColor; }
        .nav-item span { font-size: 12px; }

        /* --- Back Button --- */
        .back-button-top { position: fixed; top: 15px; left: 65px; background-color: rgba(0, 0, 0, 0.6); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 1001; }

        html.plyr--fullscreen-active .app-header {
            display: none;
        }

        html.plyr--fullscreen-active {
            overflow: hidden !important;
        }
        html.plyr--fullscreen-active .player-wrapper {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background-color: #000;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        html.plyr--fullscreen-active video {
            width: 100% !important;
            height: 100% !important;
            aspect-ratio: auto !important;
            object-fit: contain !important;
            background-color: #000 !important;
        }

        .gesture-feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 25;
        }
        .feedback-indicator {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.5em;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .brightness-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
            pointer-events: none;
            z-index: 24;
            transition: opacity 0.1s linear;
        }

        #bannerAdContainer {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            width: 320px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .player-nav-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 15;
            display: flex;
            justify-content: space-between;
            align-items: center;
              padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            transition: opacity 0.3s ease;
        }
        
        .player-nav-header .logo {
            font-size: 1.8em;
            font-weight: 900;
            text-shadow: none;
            background: linear-gradient(90deg, #00E1FF, #E900FF);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .player-nav-header i {
            width: 24px;
            height: 24px;
            cursor: pointer;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        html.plyr--fullscreen-active .player-nav-header {
            display: flex !important;
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        html.plyr--fullscreen-active .player-back-btn {
            display: flex !important;
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        .buffering-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 30;
        }
        
        .buffering-indicator.active {
            display: block;
        }
        
        .buffering-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--netflix-red);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .network-quality {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 10px;
        }
        
        .app-header.header-solid {
            background-color: #17181f;
        }

        .network-quality.good {
            background-color: rgba(0, 128, 0, 0.7);
        }
        
        .network-quality.medium {
            background-color: rgba(255, 165, 0, 0.7);
        }
        
        .network-quality.poor {
            background-color: rgba(255, 0, 0, 0.7);
        }
        
        .trailer-section {
            margin-top: 25px;
            overflow: hidden;
            display: none;
        }
        
        .trailer-section.active {
            display: block;
        }
        
        .trailer-section h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        .trailer-section h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background-color: var(--netflix-red);
            border-radius: 2px;
        }
        
        .trailer-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .trailer-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .trailer-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        
        .trailer-container:hover .trailer-play-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .trailer-play-button {
            width: 70px;
            height: 70px;
            background-color: rgba(229, 9, 20, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .trailer-container:hover .trailer-play-button {
            transform: scale(1.1);
            background-color: var(--netflix-red);
        }
        
        .trailer-play-button i {
            width: 30px;
            height: 30px;
            fill: white;
            margin-left: 3px;
        }
        
        .trailer-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .trailer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .trailer-modal.active {
            display: flex;
        }
        
        .trailer-modal-content {
            width: 90%;
            max-width: 900px;
            aspect-ratio: 16 / 9;
            position: relative;
        }
        
        .trailer-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            z-index: 10001;
        }
        
        .trailer-player-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .profile-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
        }
        
        .profile-avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--netflix-red);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid var(--secondary-bg);
        }
        
        .profile-avatar-upload i {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        .profile-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .profile-form input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #333;
            color: white;
            font-size: 1em;
            box-sizing: border-box;
        }
        
        .profile-form button {
            padding: 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--netflix-red);
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .profile-info {
            width: 100%;
            max-width: 400px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .profile-info-label {
            color: var(--text-secondary);
        }
        
        .profile-info-value {
            color: var(--text-primary);
        }
        
        .profile-logout-btn {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            border-radius: 8px;
            border: none;
            background-color: #333;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .avatar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .avatar-modal.active {
            display: flex;
        }
        
        .avatar-modal-content {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .avatar-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .avatar-modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .avatar-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s;
        }
        
        .avatar-option:hover {
            border-color: var(--accent-color);
        }
        
        .avatar-option.selected {
            border-color: var(--netflix-red);
        }

        .new-movie-notification {
            position: fixed;
            top: -150px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid var(--netflix-red);
            border-radius: 12px;
            padding: 15px;
            z-index: 10000;
            max-width: 350px;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        
        .new-movie-notification.show {
            top: 80px;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        .notification-poster img {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .notification-info {
            flex: 1;
            color: white;
        }
        
        .notification-title {
            font-size: 0.9em;
            color: var(--netflix-red);
            font-weight: bold;
            margin-bottom: 5px;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px rgba(229, 9, 20, 0.5); }
            50% { text-shadow: 0 0 20px rgba(229, 9, 20, 0.8); }
        }
        
        .notification-movie-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .notification-movie-category {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .notification-watch-btn {
            background: var(--netflix-red);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .notification-watch-btn:hover {
            background: #ff0a16;
        }
        
        .notification-close-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .enable-notifications-btn {
            background-color: var(--netflix-red);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            max-width: 400px;
            transition: background-color 0.3s;
        }
        
        .enable-notifications-btn:hover {
            background-color: #ff0a16;
        }
        
        /* Trending section special styles */
        .trending-swiper .swiper-slide {
            transition: transform 0.3s ease;
        }

        .trending-swiper .swiper-slide:hover {
            transform: scale(1.05);
        }

        .trending-swiper .swiper-wrapper {
            transition-timing-function: linear !important;
        }
        
        /* Autoplay Overlay Styles */
        #autoplay-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 320px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        #autoplay-overlay img {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        #autoplay-overlay .autoplay-info {
            flex: 1;
        }
        
        #autoplay-overlay .autoplay-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        
        #autoplay-overlay .autoplay-subtitle {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 8px;
        }
        
        #autoplay-overlay .autoplay-timer {
            font-size: 0.8em;
            color: var(--netflix-red);
            font-weight: bold;
        }
        
        #autoplay-overlay #cancel-autoplay {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        #autoplay-overlay #cancel-autoplay:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Autoplay Toggle Styles */
        .plyr__autoplay-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0 10px;
            position: relative;
            margin-left: auto;
        }

        .plyr__autoplay-toggle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .plyr__autoplay-label {
            font-size: 11px;
            color: var(--plyr-control-text-color, #fff);
            text-align: center;
            font-weight: 500;
        }

        .plyr__autoplay-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            transition: background-color 0.3s;
        }

        .plyr__autoplay-switch--on {
            background-color: var(--plyr-color-main, var(--netflix-red));
        }

        .plyr__autoplay-toggle-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .plyr__autoplay-switch--on .plyr__autoplay-toggle-handle {
            transform: translateX(16px);
        }

        /* Mobile responsive styles for autoplay toggle */
        @media (max-width: 768px) {
            .plyr__autoplay-label {
                font-size: 9px;
            }
            
            .plyr__autoplay-switch {
                width: 32px;
                height: 18px;
            }
            
            .plyr__autoplay-toggle-handle {
                width: 14px;
                height: 14px;
            }
            
            .plyr__autoplay-switch--on .plyr__autoplay-toggle-handle {
                transform: translateX(14px);
            }
        }

        @media (max-width: 480px) {
            .plyr__autoplay-toggle {
                padding: 0 5px;
            }
            
            .plyr__autoplay-label {
                font-size: 8px;
            }
            
            .plyr__autoplay-switch {
                width: 28px;
                height: 16px;
            }
            
            .plyr__autoplay-toggle-handle {
                width: 12px;
                height: 12px;
            }
            
            .plyr__autoplay-switch--on .plyr__autoplay-toggle-handle {
                transform: translateX(12px);
            }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
                padding: 0 10px;
            }
            
            .tv-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
                padding: 0 10px;
            }
            
            .featured-carousel {
                height: 50vh;
                min-height: 250px;
            }
            
            .featured-title {
                font-size: 1.8em;
            }
            
            .hero-content h1 {
                font-size: 2em;
            }
            
            .play-button-main {
                font-size: 1em;
                padding: 10px;
            }
            
            .action-buttons-container {
                gap: 15px;
            }
            
            .action-btn {
                font-size: 0.8em;
            }
            
            .category-grid-homepage {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 0 10px;
            }
            
            .category-card-homepage span {
                font-size: 0.9em;
            }
            
            .app-header {
                padding: 10px;
            }
            
            .app-header .logo {
                font-size: 1.8em;
            }
            
            .page-title-bar h1 {
                font-size: 1.3em;
            }
            
            .category-title h2 {
                font-size: 1.1em;
            }
            
            .content-card-title {
                font-size: 0.8em;
            }
            
            .tv-card-title {
                font-size: 0.8em;
            }
            
            .episode-card-title {
                font-size: 0.8em;
                padding: 6px 8px;
            }
            
            .episodes-swiper .swiper-slide {
                width: 140px;
            }
            
            .detail-description {
                font-size: 0.9em;
            }
            
            .donation-container {
                padding: 15px;
            }
            
            .donation-reasons {
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .profile-container {
                padding: 15px;
            }
            
            .profile-form input {
                padding: 12px;
            }
            
            .profile-form button {
                padding: 12px;
                font-size: 1em;
            }
            
            .message-item {
                font-size: 0.9em;
            }
            
            #messageInput {
                padding: 10px;
                font-size: 0.9em;
            }
            
            #overlaySearchInput {
                padding: 12px 12px 12px 40px;
                font-size: 0.9em;
            }
            
            .search-icon-svg {
                left: 12px;
                width: 18px;
                height: 18px;
            }
            
            .close-search-btn {
                font-size: 24px;
            }
            
            .cw-card {
                padding: 10px;
                gap: 10px;
            }
            
            .cw-poster img {
                width: 60px;
                height: 85px;
            }
            
            .cw-title {
                font-size: 1em;
            }
            
            .cw-subtitle {
                font-size: 0.8em;
            }
            
            .cw-play-btn {
                width: 40px;
                height: 40px;
            }
            
            .cw-play-btn i {
                width: 20px;
                height: 20px;
            }
            
            #autoplay-overlay {
                bottom: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        @media (max-width: 480px) {
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 8px;
                padding: 0 8px;
            }
            
            .tv-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 8px;
                padding: 0 8px;
            }
            
            .featured-carousel {
                height: 40vh;
                min-height: 200px;
            }
            
            .featured-title {
                font-size: 1.5em;
            }
            
            .hero-content h1 {
                font-size: 1.8em;
            }
            
            .hero-content p {
                font-size: 0.9em;
            }
            
            .play-button-main {
                font-size: 0.9em;
                padding: 8px;
            }
            
            .action-buttons-container {
                gap: 10px;
            }
            
            .action-btn {
                font-size: 0.7em;
            }
            
            .action-btn i {
                width: 20px;
                height: 20px;
            }
            
            .category-grid-homepage {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 0 8px;
            }
            
            .category-card-homepage span {
                font-size: 0.8em;
            }
            
            .app-header {
                padding: 8px;
            }
            
            .app-header .logo {
                font-size: 1.5em;
            }
            
            .app-header i {
                width: 20px;
                height: 20px;
            }
            
            .page-title-bar {
                padding: 10px;
            }
            
            .page-title-bar h1 {
                font-size: 1.2em;
            }
            
            .category-title h2 {
                font-size: 1em;
            }
            
            .content-card-title {
                font-size: 0.7em;
            }
            
            .tv-card-title {
                font-size: 0.7em;
            }
            
            .episode-card-title {
                font-size: 0.7em;
                padding: 4px 6px;
            }
            
            .episodes-swiper .swiper-slide {
                width: 120px;
            }
            
            .detail-description {
                font-size: 0.8em;
            }
            
            .donation-container {
                padding: 10px;
            }
            
            .donation-reasons {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .donation-form {
                max-width: 300px;
            }
            
            .profile-container {
                padding: 10px;
            }
            
            .profile-avatar-container {
                width: 100px;
                height: 100px;
            }
            
            .profile-form {
                max-width: 300px;
            }
            
            .profile-form input {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .profile-form button {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .profile-info {
                max-width: 300px;
                padding: 15px;
            }
            
            .profile-logout-btn {
                max-width: 300px;
                padding: 10px;
                font-size: 0.9em;
            }
            
            .message-item {
                font-size: 0.8em;
            }
            
            #messageInput {
                padding: 8px;
                font-size: 0.8em;
            }
            
            #messageForm button {
                width: 40px;
                height: 40px;
            }
            
            #overlaySearchInput {
                padding: 10px 10px 10px 35px;
                font-size: 0.8em;
            }
            
            .search-icon-svg {
                left: 10px;
                width: 16px;
                height: 16px;
            }
            
            .close-search-btn {
                font-size: 20px;
            }
            
            .cw-card {
                padding: 8px;
                gap: 8px;
            }
            
            .cw-poster img {
                width: 50px;
                height: 70px;
            }
            
            .cw-title {
                font-size: 0.9em;
            }
            
            .cw-subtitle {
                font-size: 0.7em;
            }
            
            .cw-play-btn {
                width: 35px;
                height: 35px;
            }
            
            .cw-play-btn i {
                width: 18px;
                height: 18px;
            }
            
            .bottom-nav {
                height: 55px;
            }
            
            .nav-item i {
                width: 20px;
                height: 20px;
            }
            
            .nav-item span {
                font-size: 10px;
            }
            
            #autoplay-overlay {
                bottom: 70px;
                padding: 12px;
                gap: 12px;
            }
            
            #autoplay-overlay img {
                width: 50px;
                height: 75px;
            }
            
            #autoplay-overlay .autoplay-title {
                font-size: 0.9em;
            }
            
            #autoplay-overlay .autoplay-subtitle {
                font-size: 0.75em;
            }
            
            #autoplay-overlay .autoplay-timer {
                font-size: 0.75em;
            }
        }
    </style>
    
        <title>MovieFlix</title>
    
    <!-- PWA CHANGES YAHAN PASTE KAREIN -->
    <meta name="theme-color" content="#E50914">
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS support for PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Plyr.js CSS for modern player UI -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
</head>
<body>

<!-- Progress Bar -->
<div class="progress-bar" id="progressBar"></div>

<!-- Network Status -->
<div class="network-status" id="networkStatus">
    <span id="networkStatusText">No Internet Connection</span>
</div>

<!-- Welcome Popup -->
<div id="welcomePopup" class="welcome-popup">
    <div class="welcome-particles" id="welcomeParticles"></div>
    <div class="welcome-icon">🎬</div>
    <div class="welcome-text" id="welcomeText"></div>
    <div class="welcome-progress"></div>
</div>

<!-- Update Popup -->
<div id="updatePopup" class="update-popup">
    <div class="update-popup-content">
        <div class="update-popup-icon">🔄</div>
        <h2 class="update-popup-title">New Update Available!</h2>
        <p class="update-popup-message">A new version of MovieFlix is available. Please update to get the latest features and improvements.</p>
        <div class="update-popup-buttons">
            <button id="downloadUpdateBtn" class="update-popup-btn download">Download Now</button>
            <button id="laterUpdateBtn" class="update-popup-btn later">Later</button>
        </div>
        <button class="update-popup-close" onclick="closeUpdatePopup()">×</button>
    </div>
</div>

<div id="authContainer" class="page active"><div class="auth-overlay"><div class="auth-box"> <div id="signInView"><h1>Sign In</h1><form class="auth-form" onsubmit="handleLogin(event)"><input type="email" placeholder="Email" required autocomplete="email"><input type="password" placeholder="Password" required autocomplete="current-password"><button type="submit">Sign In</button></form><p class="auth-toggle-text">New to MovieFlix? <a onclick="toggleAuthView('signup')">Sign up now.</a></p></div> <div id="signUpView" style="display: none;"><h1>Sign Up</h1><form class="auth-form" onsubmit="handleSignUp(event)"><input type="email" placeholder="Email" required autocomplete="email"><input type="password" placeholder="Password" required autocomplete="new-password"><button type="submit">Sign Up</button></form><p class="auth-toggle-text">Already have an account? <a onclick="toggleAuthView('signin')">Sign in now.</a></p></div></div></div></div>
<div id="splashScreen" class="page"><div class="splash-content"><div class="logo">MovieFlix</div></div></div>
<div id="mainApp" class="page">
    <div id="menuOverlay" onclick="closeMenu()"></div>
    <nav id="sideMenu">
        <div class="menu-profile">
            <img id="menuProfileAvatar" class="menu-profile-avatar" src="https://picsum.photos/seed/default/60/60.jpg" alt="Profile">
            <h3 id="menuProfileName">User Profile</h3>
        </div>
        <div class="menu-item" onclick="showHomePage()">
            <i class="fas fa-home"></i> Home
        </div>
        <div class="menu-item" onclick="showMoviesPage()">
            <i class="fas fa-film"></i> Movies
        </div>
        <div class="menu-item" onclick="showSeriesPage()">
            <i class="fas fa-tv"></i> Series
        </div>
        <div class="menu-item" onclick="showLiveTvPage()">
            <i class="fas fa-broadcast-tower"></i> Live TV
        </div>
        <div class="menu-item" onclick="showAnimationPage()">
            <i class="fas fa-dragon"></i> Animation
        </div>
        <div class="menu-item" onclick="showMyListPage()">
            <i class="fas fa-bookmark"></i> My List
        </div>
        <div class="menu-item" onclick="showKidsPage()">
            <i class="fas fa-child"></i> Kids
        </div>
        <div class="menu-item" onclick="showDiscussPage()">
            <i class="fas fa-comments"></i> Discuss
        </div>
        <div class="menu-item" onclick="showProfilePage()">
            <i class="fas fa-user-circle"></i> My Profile
        </div>
        <div class="menu-item" onclick="showDonationPage()">
            <i class="fas fa-donate"></i> Donation
        </div>
    </nav>
    
<header class="app-header" id="appHeader">
    <button id="headerBackBtn" onclick="goBack()" style="display: none; background: none; border: none; color: white; cursor: pointer;">
        <i class="fas fa-arrow-left" style="font-size: 24px;"></i>
    </button>
    
    <button id="headerMenuBtn" onclick="openMenu()" style="background: none; border: none; color: white; cursor: pointer;">
        <i class="fas fa-bars" style="font-size: 24px;"></i>
    </button>
    
    <div class="logo">MovieFlix</div>
    
    <button onclick="openSearchOverlay()" style="background: none; border: none; color: white; cursor: pointer;">
        <i class="fas fa-search" style="font-size: 24px;"></i>
    </button>
</header>

<main id="mainContent"></main>

<nav id="bottomNav" style="display: none;">
    <div class="nav-item active" data-page="home" onclick="showHomePage()">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </div>
    <div class="nav-item" data-page="movies" onclick="showMoviesPage()">
        <i class="fas fa-film"></i>
        <span>Movies</span>
    </div>
    <div class="nav-item" data-page="series" onclick="showSeriesPage()">
        <i class="fas fa-tv"></i>
        <span>Series</span>
    </div>
    <div class="nav-item" data-page="livetv" onclick="showLiveTvPage()">
        <i class="fas fa-broadcast-tower"></i>
        <span>Live TV</span>
    </div>
    <div class="nav-item" data-page="kids" onclick="showKidsPage()">
        <i class="fas fa-child"></i>
        <span>Kids</span>
    </div>
</nav>

<button class="back-button-top" id="backButton" onclick="showHomePage()">
    <i class="fas fa-arrow-left"></i>
</button>

<div id="searchOverlay">
    <div class="search-overlay-header">
        <div class="search-bar-wrapper">
            <i class="fas fa-search search-icon-svg" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--text-secondary);"></i>
            <input type="text" id="overlaySearchInput" placeholder="Search for movies, series..." autofocus>
            <div class="search-suggestions-container" id="searchSuggestionsContainer"></div>
        </div>
        <button class="close-search-btn" onclick="closeSearchOverlay()">×</button>
    </div>
    
    <div id="searchHistorySection" style="display: block; margin-top: 15px;">
        <div class="search-history-header" style="display: flex; justify-content: space-between; align-items: center; padding: 0 15px 10px;">
            <h3 style="margin: 0; font-size: 1.1em; color: var(--text-secondary);">Recent Searches</h3>
            <button id="clearSearchHistory" style="background: none; border: none; color: var(--netflix-red); cursor: pointer; font-size: 0.9em;">Clear All</button>
        </div>
        <div id="searchHistoryList" class="search-history-list" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 0 15px 15px;"></div>
    </div>
    
    <div id="overlaySearchResults" class="content-grid"></div>
</div>
</div>

<!-- Trailer Modal -->
<div id="trailerModal" class="trailer-modal">
    <div class="trailer-modal-content">
        <span class="trailer-modal-close" onclick="closeTrailerModal()">×</span>
        <div class="trailer-player-wrapper">
            <div id="trailerPlayer"></div>
        </div>
    </div>
</div>

<!-- Avatar Selection Modal -->
<div id="avatarModal" class="avatar-modal">
    <div class="avatar-modal-content">
        <div class="avatar-modal-header">
            <h2 class="avatar-modal-title">Choose Avatar</h2>
            <button class="avatar-modal-close" onclick="closeAvatarModal()">×</button>
        </div>
        <div class="avatar-grid" id="avatarGrid">
            <!-- Avatar options will be populated here -->
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div id="editMessageModal" class="edit-message-modal">
    <div class="edit-message-container">
        <div class="edit-message-header">
            <h3 class="edit-message-title">Edit Message</h3>
            <button class="edit-message-close" onclick="closeEditMessageModal()">×</button>
        </div>
        <textarea id="editMessageInput" class="edit-message-input" rows="4" placeholder="Edit your message..."></textarea>
        <div class="edit-message-actions">
            <button class="edit-message-btn edit-message-cancel" onclick="closeEditMessageModal()">Cancel</button>
            <button class="edit-message-btn edit-message-save" onclick="saveEditedMessage()">Save</button>
        </div>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script type="module">
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
  apiKey: "AIzaSyAH2LzRhPxKZGxo-g8XPn5QT2swH_Xu1OQ",
  authDomain: "movieapp-e0c88.firebaseapp.com",
  databaseURL: "https://movieapp-e0c88-default-rtdb.firebaseio.com",
  projectId: "movieapp-e0c88",
  storageBucket: "movieapp-e0c88.firebasestorage.app",
  messagingSenderId: "804490410951",
  appId: "1:804490410951:web:badddbb20401bfb0c237e2",
  measurementId: "G-P5J24YC9NK"
};
    // --- FIREBASE INITIALIZATION ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, increment, addDoc, query, orderBy, onSnapshot, serverTimestamp, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- GLOBAL STATE & ELEMENTS ---
    const SPREADSHEET_ID = '...';
    const API_KEY = '...';

    const mainContent = document.getElementById('mainContent');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const appHeader = document.getElementById('appHeader');
    const backButton = document.getElementById('backButton');
    const searchOverlay = document.getElementById('searchOverlay');
    const trailerModal = document.getElementById('trailerModal');
    const avatarModal = document.getElementById('avatarModal');
    const editMessageModal = document.getElementById('editMessageModal');
    const welcomePopup = document.getElementById('welcomePopup');
    const welcomeText = document.getElementById('welcomeText');
    const welcomeParticles = document.getElementById('welcomeParticles');
    const progressBar = document.getElementById('progressBar');
    const networkStatus = document.getElementById('networkStatus');
    const networkStatusText = document.getElementById('networkStatusText');
    
    let allMovies = [], allSeries = [], allAnimations = [], allTvChannels = [], allContent = [], homepageCategoryImages = {};
    let userProfiles = {};

    let qrCodeUrl = 'https://i.imgur.com/s0C0gDE.png';
    let upiId = '';
    let recipientName = 'MovieFlix Donation';

    let player, hls, trailerPlayer;
    let currentPageRender = null;
    let unsubscribeChat;
    let activeContentDetails = null;
    let networkQualityInterval;
    let isMoviePlaying = false;
    
    let currentAppVersion = "1.0.0";
    let updateInfo = null;
    
    let editingMessageId = null;
    let longPressTimer = null;
    let touchStartTime = 0;

    // --- CACHING SYSTEM ---
    const CACHE_VERSION = '1.0.0';
    const CACHE_EXPIRY = 30 * 60 * 1000; // 30 minutes
    
    const cacheManager = {
        get: function(key) {
            try {
                const cached = localStorage.getItem(`cache_${key}`);
                if (!cached) return null;
                
                const { data, timestamp, version } = JSON.parse(cached);
                
                if (version !== CACHE_VERSION || Date.now() - timestamp > CACHE_EXPIRY) {
                    localStorage.removeItem(`cache_${key}`);
                    return null;
                }
                
                return data;
            } catch (e) {
                console.error('Cache get error:', e);
                return null;
            }
        },
        
        set: function(key, data) {
            try {
                const cacheData = {
                    data,
                    timestamp: Date.now(),
                    version: CACHE_VERSION
                };
                localStorage.setItem(`cache_${key}`, JSON.stringify(cacheData));
            } catch (e) {
                console.error('Cache set error:', e);
            }
        },
        
        clear: function() {
            try {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cache_')) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.error('Cache clear error:', e);
            }
        }
    };

    // --- NETWORK STATUS MONITORING ---
    function updateNetworkStatus() {
        const isOnline = navigator.onLine;
        
        if (isOnline) {
            networkStatus.classList.remove('show');
            networkStatus.classList.remove('offline');
            networkStatus.classList.add('online');
            networkStatusText.textContent = 'Back Online';
            
            setTimeout(() => {
                networkStatus.classList.remove('show');
            }, 3000);
        } else {
            networkStatus.classList.add('show');
            networkStatus.classList.add('offline');
            networkStatus.classList.remove('online');
            networkStatusText.textContent = 'No Internet Connection';
        }
    }
    
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    
    // --- LAZY LOADING FOR IMAGES ---
    function setupLazyLoading() {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.add('loaded');
                    img.classList.remove('lazy-image');
                    observer.unobserve(img);
                }
            });
        });
        
        document.querySelectorAll('img.lazy-image').forEach(img => {
            imageObserver.observe(img);
        });
    }

    // --- HEADER SCROLL EFFECT ---
    window.addEventListener('scroll', () => {
        if (window.scrollY > 50) { appHeader.classList.add('scrolled'); } else { appHeader.classList.remove('scrolled'); }
    });

    // --- AUTH & STARTUP ---
    (function checkLoginStatus() { 
        if (localStorage.getItem('isLoggedIn') === 'true') { 
            startAppFlow(); 
        } 
    })();
    
    function showWelcomePopup(isLogin = true) {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return;
        
        const profileKey = `movieflix-profile-${userEmail}`;
        const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
        const nickname = profileData.nickname || userEmail.split('@')[0];
        
        const welcomeMessage = isLogin ? `Welcome back, ${nickname}!` : `Welcome, ${nickname}!`;
        welcomeText.textContent = welcomeMessage;
        
        createParticles();
        
        welcomePopup.classList.add('show');
        
        setTimeout(() => {
            welcomePopup.classList.remove('show');
            welcomePopup.classList.add('hide');
            
            setTimeout(() => {
                welcomePopup.classList.remove('hide');
                welcomeParticles.innerHTML = '';
            }, 500);
        }, 4000);
    }
    
    function createParticles() {
        welcomeParticles.innerHTML = '';
        const particleCount = 15;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            
            const size = Math.random() * 5 + 2;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            const posX = Math.random() * 100;
            const posY = Math.random() * 100;
            particle.style.left = `${posX}%`;
            particle.style.top = `${posY}%`;
            
            const delay = Math.random() * 2;
            particle.style.animationDelay = `${delay}s`;
            
            welcomeParticles.appendChild(particle);
        }
    }
    
    // --- NOTIFICATION SYSTEM VARIABLES ---
    let lastCheckedMovies = [];
    let notificationPermission = false;
    let movieCheckInterval = null;

    // --- NOTIFICATION SYSTEM FUNCTIONS ---
    const initializeNotificationSystem = async () => {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                notificationPermission = true;
                console.log('Notification permission already granted');
                
                const savedMovies = localStorage.getItem('lastCheckedMovies');
                if (savedMovies) {
                    lastCheckedMovies = JSON.parse(savedMovies);
                }
            } 
            else if (Notification.permission === 'denied') {
                notificationPermission = false;
                console.log('Notification permission denied');
            }
            else {
                notificationPermission = false;
                console.log('Notification permission not requested yet');
            }
        }
    };

    const requestNotificationPermission = async () => {
        if ('Notification' in window && Notification.permission === 'default') {
            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
                
                if (notificationPermission) {
                    console.log('Notification permission granted');
                    
                    const savedMovies = localStorage.getItem('lastCheckedMovies');
                    if (savedMovies) {
                        lastCheckedMovies = JSON.parse(savedMovies);
                    }
                    
                    showNotificationPermissionSuccess();
                    
                    if (document.querySelector('.profile-container')) {
                        renderProfilePage();
                    }
                } else {
                    console.log('Notification permission denied');
                    
                    if (document.querySelector('.profile-container')) {
                        renderProfilePage();
                    }
                }
                
                return notificationPermission;
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                return false;
            }
        }
        return Notification.permission === 'granted';
    };

    const showNotificationPermissionSuccess = () => {
        const successMessage = document.createElement('div');
        successMessage.style.position = 'fixed';
        successMessage.style.top = '20px';
        successMessage.style.left = '50%';
        successMessage.style.transform = 'translateX(-50%)';
        successMessage.style.backgroundColor = 'rgba(0, 128, 0, 0.8)';
        successMessage.style.color = 'white';
        successMessage.style.padding = '10px 20px';
        successMessage.style.borderRadius = '5px';
        successMessage.style.zIndex = '9999';
        successMessage.textContent = 'Notifications enabled! You will receive alerts for new movies.';
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
            document.body.removeChild(successMessage);
        }, 3000);
    };

    const addNotificationPermissionButton = () => {
        if ('Notification' in window && Notification.permission === 'default') {
            const notificationButton = document.createElement('div');
            notificationButton.className = 'menu-item';
            notificationButton.innerHTML = `
                <i class="fas fa-bell"></i>
                <span>Enable Notifications</span>
            `;
            notificationButton.onclick = async () => {
                const granted = await requestNotificationPermission();
                if (granted) {
                    notificationButton.remove();
                }
            };
            
            const sideMenu = document.getElementById('sideMenu');
            const profileMenuItem = sideMenu.querySelector('.menu-item:nth-last-child(2)');
            sideMenu.insertBefore(notificationButton, profileMenuItem);
        }
    };

    const checkForNewMoviesAndNotify = async () => {
        try {
            const moviesData = await fetchGoogleSheetData('Movies');
            
            if (moviesData.length === 0) return;
            
            const visibleMovies = moviesData.filter(movie => 
                movie.show && movie.show.toLowerCase() === 'true'
            );
            
            if (visibleMovies.length === 0) return;
            
            const latestMovies = visibleMovies.slice(0, 5);
            
            const newMovies = latestMovies.filter(movie => 
                !lastCheckedMovies.some(checkedMovie => checkedMovie.id === movie.id)
            );
            
            if (newMovies.length > 0 && notificationPermission) {
                console.log('New movies found:', newMovies);
                
                newMovies.forEach(movie => {
                    try {
                        const notification = new Notification('🎬 New Movie on MovieFlix!', {
                            body: `${movie.title} is now available to watch!`,
                            icon: movie.posterurl || 'https://picsum.photos/seed/movie/100/100.jpg',
                            badge: 'https://picsum.photos/seed/badge/50/50.jpg',
                            tag: movie.id,
                            requireInteraction: false,
                            silent: false
                        });
                        
                        notification.onclick = () => {
                            showDetailView(movie.id, movie.type);
                            notification.close();
                        };
                        
                        console.log('Browser notification sent for:', movie.title);
                    } catch (error) {
                        console.error('Browser notification failed:', error);
                    }
                    
                    showInAppNotification(movie);
                    
                    if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                        alert(`New Movie: ${movie.title}`);
                    }
                });
                
                playNotificationSound();
            }
            
            lastCheckedMovies = latestMovies;
            localStorage.setItem('lastCheckedMovies', JSON.stringify(lastCheckedMovies));
            
        } catch (error) {
            console.error('Error checking for new movies:', error);
        }
    };

    window.testNotification = () => {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                const testMovie = {
                    id: 'test_' + Date.now(),
                    title: 'Test Movie',
                    posterurl: 'https://picsum.photos/seed/test/100/100.jpg',
                    category: 'Test',
                    type: 'movie'
                };
                
                showInAppNotification(testMovie);
                
                try {
                    const notification = new Notification('🎬 Test Notification', {
                        body: 'This is a test notification from MovieFlix!',
                        icon: 'https://picsum.photos/seed/test/100/100.jpg',
                        tag: 'test_notification'
                    });
                    
                    setTimeout(() => {
                        notification.close();
                    }, 5000);
                    
                    console.log('Test notification sent successfully');
                } catch (error) {
                    console.error('Test notification failed:', error);
                }
            } else {
                console.log('Notification permission not granted');
                requestNotificationPermission();
            }
        } else {
            console.log('Notification API not supported');
        }
    };

    const showInAppNotification = (movie) => {
        const popup = document.createElement('div');
        popup.className = 'new-movie-notification';
        popup.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid var(--netflix-red);
            border-radius: 12px;
            padding: 15px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            transform: translateY(-100px);
            transition: transform 0.5s ease-out;
        `;
        
        popup.innerHTML = `
            <div class="notification-poster">
                <img src="${movie.posterurl || 'https://picsum.photos/seed/movie/80/120.jpg'}" alt="${movie.title}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 6px;">
            </div>
            <div class="notification-info" style="flex: 1; color: white;">
                <div class="notification-title" style="font-size: 0.9em; color: var(--netflix-red); font-weight: bold; margin-bottom: 5px;">🎬 NEW MOVIE!</div>
                <div class="notification-movie-title" style="font-size: 1.1em; font-weight: bold; margin-bottom: 3px;">${movie.title}</div>
                <div class="notification-movie-category" style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">${movie.category || 'New Release'}</div>
                <button class="notification-watch-btn" onclick="showDetailView('${movie.id}', '${movie.type}')" style="background: var(--netflix-red); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; cursor: pointer;">Watch Now</button>
            </div>
            <button class="notification-close-btn" onclick="this.parentElement.remove()" style="position: absolute; top: 5px; right: 5px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">×</button>
        `;
        
        document.body.appendChild(popup);
        
        setTimeout(() => {
            popup.style.transform = 'translateY(0)';
        }, 100);
        
        setTimeout(() => {
            popup.style.transform = 'translateY(-100px)';
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.parentElement.removeChild(popup);
                }
            }, 500);
        }, 10000);
        
        if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
        }
    };

    const playNotificationSound = () => {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Could not play sound'));
    };

    const startNotificationSystem = async () => {
        await initializeNotificationSystem();
        
        await checkForNewMoviesAndNotify();
        
        movieCheckInterval = setInterval(checkForNewMoviesAndNotify, 2 * 60 * 1000);
    };
    
    function startAppFlow() { 
        if (player) {
            player.destroy();
            player = null;
        }
        if (hls) {
            hls.destroy();
            hls = null;
        }
        if (trailerPlayer) {
            trailerPlayer.destroy();
            trailerPlayer = null;
        }
        
        document.getElementById('authContainer').classList.remove('active'); 
        const splash = document.getElementById('splashScreen'); 
        splash.style.display = 'flex'; 
        setTimeout(async () => { 
            splash.style.display = 'none'; 
            document.getElementById('mainApp').classList.add('active'); 
            document.getElementById('bottomNav').style.display = 'flex'; 
            const userEmail = localStorage.getItem('userEmail'); 
            if (userEmail) { 
                loadUserProfile();
                showWelcomePopup(true);
            } 
            await initializeNotificationSystem();
            
            setTimeout(() => {
                addNotificationPermissionButton();
            }, 2000);
            
            await startNotificationSystem();
            
            initializeAppView(); 
        }, 1500); 
    }

    function loadUserProfile() {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return;
        
        const profileKey = `movieflix-profile-${userEmail}`;
        const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
        
        const menuProfileName = document.getElementById('menuProfileName');
        const menuProfileAvatar = document.getElementById('menuProfileAvatar');
        
        if (profileData.nickname) {
            menuProfileName.textContent = profileData.nickname;
        } else {
            menuProfileName.textContent = userEmail.split('@')[0];
        }
        
        if (profileData.avatar) {
            menuProfileAvatar.src = profileData.avatar;
        } else {
            menuProfileAvatar.src = `https://picsum.photos/seed/${userEmail}/60/60.jpg`;
        }
    }

    const handleAuth = (e, isSignUp) => {
        e.preventDefault();
        const button = e.target.querySelector('button');
        button.disabled = true;
        button.textContent = isSignUp ? 'Signing Up...' : 'Signing In...';
        const email = e.target.querySelector('input[type="email"]').value;
        localStorage.setItem('userEmail', email);
        localStorage.setItem('isLoggedIn', 'true');
        
        showWelcomePopup(!isSignUp);
        
        startAppFlow();
    };
    window.handleLogin = (e) => handleAuth(e, false);
    window.handleSignUp = (e) => handleAuth(e, true);
    window.toggleAuthView = (view) => { document.getElementById('signInView').style.display = view === 'signin' ? 'block' : 'none'; document.getElementById('signUpView').style.display = view === 'signup' ? 'block' : 'none'; };
  window.handleLogout = () => { 
    if (movieCheckInterval) {
        clearInterval(movieCheckInterval);
    }
    
    localStorage.clear(); 
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('bottomNav').style.display = 'none';
    document.getElementById('authContainer').classList.add('active');
    
    const signInButton = document.querySelector('#signInView button[type="submit"]');
    if (signInButton) {
        signInButton.textContent = 'Sign In';
        signInButton.disabled = false;
    }
    
    const signInForm = document.querySelector('#signInView form');
    if (signInForm) {
        signInForm.reset();
    }
    
    toggleAuthView('signin');
};

    window.openMenu = () => { sideMenu.classList.add('open'); menuOverlay.style.display = 'block'; };
    window.closeMenu = () => { sideMenu.classList.remove('open'); menuOverlay.style.display = 'none'; };
    const updateNav = (activePage) => { document.querySelectorAll('.nav-item').forEach(item => { item.classList.toggle('active', item.dataset.page === activePage); }); };

    const showPage = (pageName, renderFunction, ...args) => {
        document.getElementById('headerMenuBtn').style.display = 'flex';
        document.getElementById('headerBackBtn').style.display = 'none';
        document.getElementById('appHeader').classList.remove('header-solid');

        if (player) {
            player.destroy();
            player = null;
        }
        if (hls) {
            hls.destroy();
            hls = null;
        }
        if (trailerPlayer) {
            trailerPlayer.destroy();
            trailerPlayer = null;
        }
        if (unsubscribeChat) unsubscribeChat();
        if (networkQualityInterval) clearInterval(networkQualityInterval);
        
        isMoviePlaying = false;
        
        closeMenu();
        updateNav(pageName);
        mainContent.innerHTML = '';
        mainContent.classList.remove('homepage-padding');
        window.scrollTo(0,0);
        backButton.style.display = 'none';
        appHeader.style.display = 'flex';
        document.getElementById('bannerAdContainer').style.display = 'flex';
        currentPageRender = () => renderFunction(...args);
        renderFunction(...args);
    };

    window.showHomePage = () => showPage('home', renderHomePage);
    window.showMoviesPage = () => showPage('movies', renderGridPage, 'All Movies', allMovies);
    window.showSeriesPage = () => showPage('series', renderGridPage, 'All Series', allSeries);
    window.showLiveTvPage = () => showPage('livetv', renderLiveTvPage);
    window.showProfilePage = () => showPage('profile', renderProfilePage);
    window.showKidsPage = () => {
        const kidsContent = allTvChannels.filter(c => c.category && c.category.toLowerCase().includes('kids'));
        showPage('kids', renderGridPage, 'Kids Corner', kidsContent);
    };
    window.showAnimationPage = () => {
        showPage('animation', renderGridPage, 'Animation', allAnimations);
    };
    window.showMyListPage = () => showPage('mylist', renderMyListPage);
    window.showDiscussPage = () => {
        showPage('discuss', renderDiscussPage);
        document.getElementById('bannerAdContainer').style.display = 'none';
    };
    window.showDonationPage = () => showPage('donation', renderDonationPage);

    window.showCategoryPage = (categoryName) => {
        const categoryContent = allContent.filter(item =>
            item.category && item.category.split(',').map(c => c.trim().toLowerCase()).includes(categoryName.toLowerCase())
        );
        showPage('home', renderGridPage, categoryName, categoryContent);
    };

    // --- SEARCH HISTORY MANAGEMENT ---
    const MAX_SEARCH_HISTORY = 10;

    function saveSearchQuery(query) {
        if (!query || query.trim() === '') return;
        
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return;
        
        const searchHistoryKey = `movieflix-search-history-${userEmail}`;
        let searchHistory = JSON.parse(localStorage.getItem(searchHistoryKey)) || [];
        
        searchHistory = searchHistory.filter(item => item !== query);
        
        searchHistory.unshift(query);
        
        searchHistory = searchHistory.slice(0, MAX_SEARCH_HISTORY);
        
        localStorage.setItem(searchHistoryKey, JSON.stringify(searchHistory));
        
        renderSearchHistory();
    }

    function getSearchHistory() {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return [];
        
        const searchHistoryKey = `movieflix-search-history-${userEmail}`;
        return JSON.parse(localStorage.getItem(searchHistoryKey)) || [];
    }

    window.handleDeleteHistoryItem = function(event, query) {
        event.stopPropagation();
        removeSearchQuery(query);
    }

    function removeSearchQuery(query) {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return;
        
        const searchHistoryKey = `movieflix-search-history-${userEmail}`;
        let searchHistory = JSON.parse(localStorage.getItem(searchHistoryKey)) || [];
        
        searchHistory = searchHistory.filter(item => item !== query);
        
        localStorage.setItem(searchHistoryKey, JSON.stringify(searchHistory));
        renderSearchHistory();
    }

    function clearSearchHistory() {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return;
        
        const searchHistoryKey = `movieflix-search-history-${userEmail}`;
        localStorage.removeItem(searchHistoryKey);
        renderSearchHistory();
    }

    function renderSearchHistory() {
        const searchHistory = getSearchHistory();
        const searchHistorySection = document.getElementById('searchHistorySection');
        const searchHistoryList = document.getElementById('searchHistoryList');
        
        if (searchHistory.length === 0) {
            searchHistorySection.style.display = 'none';
            return;
        }
        
        searchHistorySection.style.display = 'block';
        
        searchHistoryList.innerHTML = searchHistory.map(query => `
            <div class="search-history-item" onclick="searchFromHistory('${query.replace(/'/g, "\\'")}')">
                <i class="fas fa-history"></i>
                ${query}
                <i class="fas fa-times search-history-item-delete" onclick="handleDeleteHistoryItem(event, '${query.replace(/'/g, "\\'")}')" style="margin-left: 5px; cursor: pointer; opacity: 0.7;"></i>
            </div>
        `).join('');
    }

   window.searchFromHistory = function(query) {
        const exactMatch = allContent.find(item => item.title.toLowerCase() === query.toLowerCase());

        if (exactMatch) {
            closeSearchOverlay();
            showDetailView(exactMatch.id, exactMatch.type);
        } else {
            document.getElementById('overlaySearchInput').value = query;
            performSearch(query);
        }
    }

    function performSearch(searchTerm) {
        const resultsContainer = document.getElementById('overlaySearchResults');
        const suggestionsContainer = document.getElementById('searchSuggestionsContainer');
        
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('empty');
            suggestionsContainer.classList.remove('active');
            renderSearchHistory();
            return;
        }
        
        document.getElementById('searchHistorySection').style.display = 'none';
        
        const filtered = allContent.filter(c => {
            if (!c.title) return false;
            
            const titleMatch = c.title.toLowerCase().includes(searchTerm.toLowerCase());
            const categoryMatch = c.category && c.category.toLowerCase().includes(searchTerm.toLowerCase());
            const typeMatch = c.type && c.type.toLowerCase().includes(searchTerm.toLowerCase());
            
            return titleMatch || categoryMatch || typeMatch;
        });
        
        filtered.sort((a, b) => {
            const aExactMatch = a.title.toLowerCase() === searchTerm.toLowerCase() ? 0 : 1;
            const bExactMatch = b.title.toLowerCase() === searchTerm.toLowerCase() ? 0 : 1;
            
            if (aExactMatch !== bExactMatch) return aExactMatch - bExactMatch;
            
            const aStartsWith = a.title.toLowerCase().startsWith(searchTerm.toLowerCase()) ? 0 : 1;
            const bStartsWith = b.title.toLowerCase().startsWith(searchTerm.toLowerCase()) ? 0 : 1;
            
            if (aStartsWith !== bStartsWith) return aStartsWith - bStartsWith;
            
            return a.title.localeCompare(b.title);
        });
        
        if (filtered.length > 0) {
            const suggestions = filtered.slice(0, 5).map(item => {
                const highlightedTitle = highlightSearchTerm(item.title, searchTerm);
                return `
                    <div class="search-suggestion-item" onclick="selectSearchSuggestion('${item.id}', '${item.type}', '${item.title.replace(/'/g, "\\'")}')">
                        <img class="search-suggestion-poster" src="${item.posterurl || item.logourl}" alt="${item.title}">
                        <div class="search-suggestion-info">
                            <div class="search-suggestion-title">${highlightedTitle}</div>
                            <div class="search-suggestion-meta">${item.category || item.type}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            suggestionsContainer.innerHTML = suggestions;
            suggestionsContainer.classList.add('active');
        } else {
            suggestionsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
            suggestionsContainer.classList.add('active');
        }
        
        saveSearchQuery(searchTerm);
        
        resultsContainer.innerHTML = '';
        resultsContainer.classList.remove('empty');
        
        setupLazyLoading();
    }
    
    function highlightSearchTerm(text, searchTerm) {
        if (!text || !searchTerm) return text;
        
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        return text.replace(regex, '<span class="search-suggestion-highlight">$1</span>');
    }
    
  window.selectSearchSuggestion = function(itemId, itemType, fullTitle) {
        if (fullTitle) {
            saveSearchQuery(fullTitle);
        }

        closeSearchOverlay();
        showDetailView(itemId, itemType);
    }

    function setupSearchWithSuggestions() {
        const searchInput = document.getElementById('overlaySearchInput');
        const resultsContainer = document.getElementById('overlaySearchResults');
        const suggestionsContainer = document.getElementById('searchSuggestionsContainer');
        
        if (searchInput.hasAttribute('data-search-listener')) {
            return;
        }
        
        searchInput.setAttribute('data-search-listener', 'true');
        
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            
            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.remove('empty');
                suggestionsContainer.classList.remove('active');
                renderSearchHistory();
                return;
            }
            
            document.getElementById('searchHistorySection').style.display = 'none';
            
            const filtered = allContent.filter(c => {
                if (!c.title) return false;
                
                const titleMatch = c.title.toLowerCase().includes(searchTerm);
                const categoryMatch = c.category && c.category.toLowerCase().includes(searchTerm);
                const typeMatch = c.type && c.type.toLowerCase().includes(searchTerm);
                
                return titleMatch || categoryMatch || typeMatch;
            });
            
            filtered.sort((a, b) => {
                const aExactMatch = a.title.toLowerCase() === searchTerm ? 0 : 1;
                const bExactMatch = b.title.toLowerCase() === searchTerm ? 0 : 1;
                
                if (aExactMatch !== bExactMatch) return aExactMatch - bExactMatch;
                
                const aStartsWith = a.title.toLowerCase().startsWith(searchTerm) ? 0 : 1;
                const bStartsWith = b.title.toLowerCase().startsWith(searchTerm) ? 0 : 1;
                
                if (aStartsWith !== bStartsWith) return aStartsWith - bStartsWith;
                
                return a.title.localeCompare(b.title);
            });
            
            if (filtered.length > 0) {
                const suggestions = filtered.slice(0, 5).map(item => {
                    const highlightedTitle = highlightSearchTerm(item.title, searchTerm);
                    return `
                     <div class="search-suggestion-item" onclick="selectSearchSuggestion('${item.id}', '${item.type}', '${item.title.replace(/'/g, "\\'")}')">
                            <img class="search-suggestion-poster" src="${item.posterurl || item.logourl}" alt="${item.title}">
                            <div class="search-suggestion-info">
                                <div class="search-suggestion-title">${highlightedTitle}</div>
                                <div class="search-suggestion-meta">${item.category || item.type}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                suggestionsContainer.innerHTML = suggestions;
                suggestionsContainer.classList.add('active');
            } else {
                suggestionsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
                suggestionsContainer.classList.add('active');
            }
            
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('empty');
            
            setupLazyLoading();
        });
        
        searchInput.addEventListener('keydown', (e) => {
            const suggestions = document.querySelectorAll('.search-suggestion-item');
            let activeIndex = -1;
            
            for (let i = 0; i < suggestions.length; i++) {
                if (suggestions[i].classList.contains('active')) {
                    activeIndex = i;
                    break;
                }
            }
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % suggestions.length;
                updateActiveSuggestion(suggestions, activeIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = activeIndex <= 0 ? suggestions.length - 1 : activeIndex - 1;
                updateActiveSuggestion(suggestions, activeIndex);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    suggestions[activeIndex].click();
                } else {
                    performSearch(searchInput.value);
                }
            } else if (e.key === 'Escape') {
                suggestionsContainer.classList.remove('active');
            }
        });
        
        const clearBtn = document.getElementById('clearSearchHistory');
        if (clearBtn && !clearBtn.hasAttribute('data-clear-listener')) {
            clearBtn.setAttribute('data-clear-listener', 'true');
            clearBtn.addEventListener('click', clearSearchHistory);
        }
    }
    
    function updateActiveSuggestion(suggestions, activeIndex) {
        suggestions.forEach((suggestion, index) => {
            if (index === activeIndex) {
                suggestion.classList.add('active');
                suggestion.scrollIntoView({ block: 'nearest' });
            } else {
                suggestion.classList.remove('active');
            }
        });
    }

    window.openSearchOverlay = () => {
        searchOverlay.classList.add('active');
        document.getElementById('overlaySearchInput').focus();
        
        if (!document.getElementById('overlaySearchInput').hasAttribute('data-search-listener')) {
            setupSearchWithSuggestions();
        }
        
        renderSearchHistory();
    };
    window.closeSearchOverlay = () => {
        searchOverlay.classList.remove('active');
        document.getElementById('overlaySearchInput').value = '';
        document.getElementById('overlaySearchResults').innerHTML = '';
        document.getElementById('searchSuggestionsContainer').classList.remove('active');
        document.getElementById('searchHistorySection').style.display = 'none';
    };

    function isVersionNewer(latest, current) {
        const latestParts = latest.split('.').map(Number);
        const currentParts = current.split('.').map(Number);
        
        for (let i = 0; i < Math.max(latestParts.length, currentParts.length); i++) {
            const latestPart = latestParts[i] || 0;
            const currentPart = currentParts[i] || 0;
            
            if (latestPart > currentPart) return true;
            if (latestPart < currentPart) return false;
        }
        
        return false;
    }

    function showUpdatePopup() {
        const updatePopup = document.getElementById('updatePopup');
        updatePopup.classList.add('active');
    }

    window.closeUpdatePopup = function() {
        const updatePopup = document.getElementById('updatePopup');
        updatePopup.classList.remove('active');
    };

    async function checkForUpdates() {
        try {
            const updateData = await fetchGoogleSheetData('update_available');
            
            if (updateData && updateData.length > 0) {
                const latestUpdate = updateData[0];
                const latestVersion = latestUpdate.version || "";
                const downloadLink = latestUpdate.downloadlink || "";
                
                const lastDownloadedVersion = localStorage.getItem('lastDownloadedVersion') || "";
                
                if (latestVersion && downloadLink && 
                    isVersionNewer(latestVersion, currentAppVersion) && 
                    latestVersion !== lastDownloadedVersion) {
                    
                    updateInfo = {
                        version: latestVersion,
                        downloadLink: downloadLink
                    };
                    showUpdatePopup();
                }
            }
        } catch (error) {
            console.error("Error checking for updates:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const downloadBtn = document.getElementById('downloadUpdateBtn');
        const laterBtn = document.getElementById('laterUpdateBtn');
        
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                if (updateInfo && updateInfo.downloadLink) {
                    localStorage.setItem('lastDownloadedVersion', updateInfo.version);
                    
                    window.open(updateInfo.downloadLink, '_blank');
                    
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0, 128, 0, 0.9);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        z-index: 10001;
                        font-weight: bold;
                    `;
                    successMsg.textContent = 'Update download started! This version won\'t show again.';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        document.body.removeChild(successMsg);
                    }, 3000);
                }
                closeUpdatePopup();
            });
        }
        
        if (laterBtn) {
            laterBtn.addEventListener('click', function() {
                closeUpdatePopup();
            });
        }
    });

    function showError(message, retryCallback) {
        const errorHtml = `
            <div class="error-container">
                <div class="error-icon">⚠️</div>
                <div class="error-message">${message}</div>
                ${retryCallback ? `<button class="retry-button" onclick="${retryCallback}">Retry</button>` : ''}
            </div>
        `;
        mainContent.innerHTML = errorHtml;
    }

    function showLoadingState() {
        mainContent.innerHTML = `
            <div class="page-content-wrapper">
                <div class="content-grid">
                    ${Array(12).fill(0).map(() => `
                        <div class="skeleton-card">
                            <div class="skeleton-poster"></div>
                            <div class="skeleton-text"></div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    async function fetchGoogleSheetData(sheetName) {
    progressBar.classList.add('active');
    
    const cachedData = cacheManager.get(sheetName);
    if (cachedData) {
        progressBar.classList.remove('active');
        return cachedData;
    }
    
    // Yahan hum apne middleman server ko call kar rahe hain
    const url = `/api/getData?sheet=${sheetName}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (!data.values || data.values.length < 2) {
            console.warn(`No data found in sheet: "${sheetName}"`);
            progressBar.classList.remove('active');
            return [];
        }

        const headers = data.values[0].map(h => h.toLowerCase().replace(/\s/g, ''));
        const rows = data.values.slice(1);

        const items = rows.map(row => {
            const item = {};
            headers.forEach((header, index) => {
                item[header] = row[index] || '';
            });
            return item;
        });
        
        cacheManager.set(sheetName, items);
        
        progressBar.classList.remove('active');
        return items;
    } catch (error) {
        console.error(`Error fetching from our API for sheet "${sheetName}":`, error);
        progressBar.classList.remove('active');
        
        const fallbackData = cacheManager.get(sheetName);
        if (fallbackData) {
            console.log('Using cached data due to network error');
            return fallbackData;
        }
        
        throw error;
    }
}

    // MODIFIED: createCategoryRow function to identify trending section
    const createCategoryRow = (title, contentHtml) => {
        if(!contentHtml || contentHtml.trim() === '') return '';
        
        // Check if this is trending section
        const isTrendingSection = title.toLowerCase() === 'trending now';
        
        return `<div class="category-row">
            <div class="category-title-left" style="padding-left:15px;">
                <div class="category-title-bar"></div>
                <h2>${title}</h2>
            </div>
            <div class="swiper-container ${isTrendingSection ? 'trending-swiper' : ''}">
                <div class="swiper-wrapper">${contentHtml}</div>
            </div>
        </div>`;
    };

    const renderHomePage = async () => {
        try {
            showLoadingState();
            
            mainContent.classList.add('homepage-padding');
            
            const featured = [...allContent].sort(() => 0.5 - Math.random()).slice(0, 5);

            const trending = allContent.filter(item => item.trending && item.trending.toLowerCase() === 'true');
            const trendingHtml = createCategoryRow('Trending Now', trending.map(item => createContentCard(item)).join(''));

            const categories = {};
            allContent.forEach(item => {
                if (item.category) {
                    const itemCategories = item.category.split(',').map(c => c.trim());
                    itemCategories.forEach(cat => {
                        if (cat) {
                            if (!categories[cat]) { categories[cat] = []; }
                            categories[cat].push(item);
                        }
                    });
                }
            });

            let dynamicCategoriesHtml = '';
            for (const categoryName in categories) {
                dynamicCategoriesHtml += createCategoryRow(categoryName, categories[categoryName].map(item => createContentCard(item)).join(''));
            }

            const featuredHtml = `<div class="swiper featured-carousel"><div class="swiper-wrapper">${featured.map(item => `<div class="swiper-slide" style="background-image: url('${item.posterurl}');" onclick="showDetailView('${item.id}', '${item.type}')"><div class="featured-content"><h2 class="featured-title">${item.title}</h2><p class="featured-category">${item.category || ''} • ${item.type}</p></div></div>`).join('')}</div><div class="swiper-pagination"></div></div>`;

            const sortedCategories = Object.keys(categories).sort((a, b) => categories[b].length - categories[a].length);
            const quickCategories = sortedCategories
                .filter(catName => homepageCategoryImages[catName.toLowerCase()])
                .slice(0, 3);

            let quickCategoriesHtml = '';
            if (quickCategories.length > 0) {
                const categoryCardsHtml = quickCategories.map(catName => {
                    const imageUrl = homepageCategoryImages[catName.toLowerCase()];
                    return `
                        <div class="category-card-homepage"
                             style="background-image: url('${imageUrl}');"
                             onclick="showCategoryPage('${catName.replace(/'/g, "\\'")}')">
                            <span>${catName}</span>
                        </div>
                    `;
                }).join('');

                quickCategoriesHtml = `
                    <div class="category-row">
                        <div class="category-row-inner" style="padding-left: 0;">
                            <div class="category-title">
                                 <div class="category-title-left">
                                    <div class="category-title-bar"></div>
                                    <h2>Quick Categories</h2>
                                </div>
                            </div>
                            <div class="category-grid-homepage">
                                ${categoryCardsHtml}
                            </div>
                        </div>
                    </div>`;
            }

            mainContent.innerHTML = `
                ${featuredHtml}
                ${trendingHtml}
                <div style="padding-top: 10px;">
                    ${quickCategoriesHtml}
                    ${dynamicCategoriesHtml}
                </div>`;

            // Featured carousel initialization
            new Swiper('.featured-carousel', { 
                loop: true, 
                autoplay: { delay: 5000, disableOnInteraction: false }, 
                pagination: { el: '.swiper-pagination', clickable: true },
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                }
            });

            // MODIFIED: Swiper initialization for all other carousels with immediate autoplay for trending
            document.querySelectorAll('.swiper-container').forEach(el => {
                if (el.classList.contains('featured-carousel')) return;
                
                // Check if this is trending swiper
                const isTrending = el.classList.contains('trending-swiper');
                
                new Swiper(el, { 
                    slidesPerView: 'auto', 
                    spaceBetween: 10, 
                    freeMode: !isTrending, // Trending pe freeMode nahi
                    autoplay: isTrending ? {
                        delay: 0, // NO DELAY - immediate start
                        disableOnInteraction: false, // User interact karne ke baad bhi chalte rahega
                        pauseOnMouseEnter: true, // Mouse hover pe pause ho jayega
                        stopOnLastSlide: false, // Last slide pe nahi rukega
                    } : false, // Sirf trending pe autoplay
                    loop: isTrending, // Sirf trending pe loop
                    speed: 800, // Smooth transition speed
                    grabCursor: true, // Hand cursor on hover
                });
            });
            
            setupLazyLoading();
            
        } catch (error) {
            console.error('Error rendering homepage:', error);
            showError('Failed to load content. Please check your internet connection.', 'showHomePage()');
        }
    };

    const renderMyListPage = () => {
        const currentUserEmail = localStorage.getItem('userEmail');
        if (!currentUserEmail) {
             mainContent.innerHTML = `<div class="page-content-wrapper"><p style="text-align:center; padding: 20px;">Please log in to see your list.</p></div>`;
             return;
        }

        const continueWatchingData = JSON.parse(localStorage.getItem('movieflix-continue-watching'));
        let continueWatchingHtml = '';
        if (continueWatchingData && continueWatchingData.duration > 0 && (continueWatchingData.currentTime / continueWatchingData.duration) < 0.95) {
            const progressPercent = (continueWatchingData.currentTime / continueWatchingData.duration) * 100;
            continueWatchingHtml = `
                <div class="continue-watching-section" style="padding-top:0;">
                    <div class="category-title" style="padding-right:0;"><div class="category-title-left"><div class="category-title-bar"></div><h2>Continue Watching</h2></div></div>
                    <div class="cw-card" onclick="resumePlayback()">
                        <div class="cw-poster"><img src="${continueWatchingData.posterUrl}" alt="Poster"></div>
                        <div class="cw-info">
                            <div class="cw-title">${continueWatchingData.title}</div>
                            ${continueWatchingData.episodeTitle ? `<div class="cw-subtitle">${continueWatchingData.episodeTitle}</div>` : ''}
                            <div class="cw-progress-bar-background">
                                <div class="cw-progress-bar-foreground" style="width: ${progressPercent}%;"></div>
                            </div>
                        </div>
                        <button class="cw-play-btn">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        const storageKey = `movieflix-mylist-${currentUserEmail}`;
        const myListIds = JSON.parse(localStorage.getItem(storageKey)) || [];

        let gridHtml;
        if (myListIds.length === 0) {
            gridHtml = `<p style="text-align:center; padding: 20px;">Your list is empty. Add movies and series from their detail page.</p>`;
        } else {
            const myListItems = allContent.filter(item => myListIds.includes(item.id));
            gridHtml = `<div class="content-grid">${myListItems.map(item => createContentCard(item, true)).join('')}</div>`;
        }

        mainContent.innerHTML = `<div class="page-content-wrapper">
            ${continueWatchingHtml}
            <div class="page-title-bar" style="${continueWatchingHtml ? 'padding-top:0;' : ''}"><h1>My List</h1></div>
            ${gridHtml}
        </div>`;
        
        setupLazyLoading();
    };

    const renderLiveTvPage = () => {
        const categories = {};
        allTvChannels.forEach(channel => {
            const category = channel.category || 'General';
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(channel);
        });

        let pageHtml = '<div class="page-content-wrapper"><div class="page-title-bar"><h1>Live TV Channels</h1></div>';
        for (const category in categories) {
            const channelsHtml = categories[category].map(channel => createTvCard(channel)).join('');
            pageHtml += createCategoryRow(category, channelsHtml);
        }
        pageHtml += '</div>';
        mainContent.innerHTML = pageHtml;

        document.querySelectorAll('.category-row .swiper-container').forEach(el => {
            new Swiper(el, {
                slidesPerView: 'auto',
                spaceBetween: 10,
                freeMode: true,
            });
        });
        
        setupLazyLoading();
    };

    const renderGridPage = (title, contentList) => {
        if (!contentList || contentList.length === 0) {
             mainContent.innerHTML = `<div class="page-content-wrapper"><div class="page-title-bar"><h1>${title}</h1></div><p style="text-align:center; padding: 20px;">No content available in this section.</p></div>`;
             return;
        }
        const isTvContent = contentList[0]?.type === 'tv';
        const gridHtml = isTvContent
            ? contentList.map(item => createTvCard(item)).join('')
            : contentList.map(item => createContentCard(item, true)).join('');
        const gridClass = isTvContent ? 'tv-grid' : 'content-grid';
        mainContent.innerHTML = `<div class="page-content-wrapper"><div class="page-title-bar"><h1>${title}</h1></div><div class="${gridClass}">${gridHtml}</div></div>`;
        
        setupLazyLoading();
    };

    const renderProfilePage = () => {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) {
            mainContent.innerHTML = `<div class="page-content-wrapper"><p style="text-align:center; padding: 20px;">Please log in to view your profile.</p></div>`;
            return;
        }

        const profileKey = `movieflix-profile-${userEmail}`;
        const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
        
        const nickname = profileData.nickname || userEmail.split('@')[0];
        const avatar = profileData.avatar || `https://picsum.photos/seed/${userEmail}/120/120.jpg`;
        
        let notificationStatus = 'Unknown';
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                notificationStatus = 'Enabled';
            } else if (Notification.permission === 'denied') {
                notificationStatus = 'Disabled';
            } else {
                notificationStatus = 'Not Enabled';
            }
        } else {
            notificationStatus = 'Not Supported';
        }

        mainContent.innerHTML = `
            <div class="page-content-wrapper">
                <div class="page-title-bar"><h1>My Profile</h1></div>
                <div class="profile-container">
                    <div class="profile-avatar-container">
                        <img id="profileAvatar" class="profile-avatar" src="${avatar}" alt="Profile">
                        <div class="profile-avatar-upload" onclick="openAvatarModal()">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    
                    <form class="profile-form" onsubmit="saveProfile(event)">
                        <input type="text" id="profileNickname" placeholder="Enter your nickname" value="${nickname}" required>
                        <button type="submit">Save Profile</button>
                    </form>
                    
                    ${('Notification' in window && Notification.permission === 'default') ? `
                        <button class="enable-notifications-btn" onclick="requestNotificationPermission()">
                            Enable Movie Notifications
                        </button>
                    ` : ''}
                    
                    ${('Notification' in window && Notification.permission === 'granted') ? `
                        <button class="enable-notifications-btn" onclick="testNotification()" style="background-color: #4CAF50;">
                            Test Notification
                        </button>
                    ` : ''}
                    
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <span class="profile-info-label">Email:</span>
                            <span class="profile-info-value">${userEmail}</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Nickname:</span>
                            <span class="profile-info-value" id="displayNickname">${nickname}</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Notifications:</span>
                            <span class="profile-info-value">${notificationStatus}</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Browser:</span>
                            <span class="profile-info-value">${navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other'}</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Platform:</span>
                            <span class="profile-info-value">${/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'}</span>
                        </div>
                    </div>
                    
                    <button class="profile-logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        `;
    };

window.saveProfile = async (event) => {
    event.preventDefault();
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) return;

    const nickname = document.getElementById('profileNickname').value;
    const avatar = document.getElementById('profileAvatar').src;

    const profileData = {
        email: userEmail,
        nickname: nickname,
        avatar: avatar
    };

    const profileKey = `movieflix-profile-${userEmail}`;
    localStorage.setItem(profileKey, JSON.stringify(profileData));

    try {
        const userDocRef = doc(db, "users", userEmail);
        await setDoc(userDocRef, profileData, { merge: true });
        console.log("Profile saved to Firestore successfully!");
    } catch (error) {
        console.error("Error saving profile to Firestore: ", error);
    }

    document.getElementById('displayNickname').textContent = nickname;
    document.getElementById('menuProfileName').textContent = nickname;
    document.getElementById('menuProfileAvatar').src = avatar;

    const successMessage = document.createElement('div');
    successMessage.style.position = 'fixed';
    successMessage.style.top = '20px';
    successMessage.style.left = '50%';
    successMessage.style.transform = 'translateX(-50%)';
    successMessage.style.backgroundColor = 'rgba(0, 128, 0, 0.8)';
    successMessage.style.color = 'white';
    successMessage.style.padding = '10px 20px';
    successMessage.style.borderRadius = '5px';
    successMessage.style.zIndex = '9999';
    successMessage.textContent = 'Profile saved successfully!';
    document.body.appendChild(successMessage);

    setTimeout(() => {
        document.body.removeChild(successMessage);
    }, 3000);
};

    window.openAvatarModal = () => {
        avatarModal.classList.add('active');
        populateAvatarGrid();
    };

    window.closeAvatarModal = () => {
        avatarModal.classList.remove('active');
    };

    function populateAvatarGrid() {
        const avatarGrid = document.getElementById('avatarGrid');
        const userEmail = localStorage.getItem('userEmail');
        const profileKey = `movieflix-profile-${userEmail}`;
        const profileData = JSON.parse(localStorage.getItem(profileKey)) || {};
        const currentAvatar = profileData.avatar || `https://picsum.photos/seed/${userEmail}/120/120.jpg`;
        
        const avatarOptions = [];
        for (let i = 1; i <= 16; i++) {
            avatarOptions.push(`https://picsum.photos/seed/avatar${i}/120/120.jpg`);
        }
        
        avatarGrid.innerHTML = avatarOptions.map(avatarUrl => `
            <img class="avatar-option ${avatarUrl === currentAvatar ? 'selected' : ''}" 
                 src="${avatarUrl}" 
                 alt="Avatar" 
                 onclick="selectAvatar('${avatarUrl}')">
        `).join('');
    }

    window.selectAvatar = (avatarUrl) => {
        document.getElementById('profileAvatar').src = avatarUrl;
        
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.classList.remove('selected');
            if (option.src === avatarUrl) {
                option.classList.add('selected');
            }
        });
        
        closeAvatarModal();
    };

    const renderDonationPage = () => {
        mainContent.innerHTML = `
            <div class="page-content-wrapper">
                <div class="page-title-bar"><h1>Donation</h1></div>
                <div class="donation-container">
                    <div class="donation-reasons">
                        <p>🔸 For Adding Advance features 🚀</p>
                        <p>🔸 For more movies</p>
                    </div>
                    <div class="donation-qr">
                        <h3>Scan & Pay</h3>
                        <img src="${qrCodeUrl}" alt="Scan to pay" style="max-width: 250px; border-radius: 8px;">
                    </div>
                    <form onsubmit="handleDonation(event)" class="donation-form">
                        <div class="amount-input-wrapper">
                            <label for="donationAmount">Amount - </label>
                            <input type="number" id="donationAmount" placeholder="enter amount" required>
                        </div>
                        <button type="submit" class="donate-button">Donate now</button>
                    </form>
                </div>
            </div>
        `;
    };

    window.handleDonation = (event) => {
        event.preventDefault();
        const amount = document.getElementById('donationAmount').value;

        if (!upiId) {
            alert("Donation is not configured correctly. UPI ID is missing.");
            return;
        }
        if (!amount || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        const note = 'Donation for MovieFlix';

        const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(recipientName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;

        window.location.href = upiUrl;

        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                const toast = document.createElement('div');
                toast.className = 'upi-toast';
                toast.textContent = 'No UPI apps found or you are on a desktop.';
                document.body.appendChild(toast);
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }
        }, 1000);
    };

const renderDiscussPage = async () => {
    const adHtml = `
        <div id="discussAdContainer" style="padding-top: 60px; margin-top: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 50px; box-sizing: border-box;">
        </div>`;

    mainContent.innerHTML = `
        ${adHtml}
        <div class="discuss-page-container" style="top: 120px;">
            <div class="messages-container" id="messagesContainer"><div class="loading-spinner" style="margin: 40px auto;"></div></div>
            <div class="message-form-container">
                <form id="messageForm" style="display: flex; width: 100%;">
                    <input type="text" id="messageInput" placeholder="Type a message..." required autocomplete="off">
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>`;

    const adContainer = document.getElementById('discussAdContainer');
    if (adContainer) {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.innerHTML = `atOptions = {'key' : '4d607ded7910fca635b8c617cab0138b', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {}};`;
        const invokeScript = document.createElement('script');
        invokeScript.type = 'text/javascript';
        invokeScript.src = '//www.highperformanceformat.com/4d607ded7910fca635b8c617cab0138b/invoke.js';
        adContainer.appendChild(script);
        adContainer.appendChild(invokeScript);
    }

    try {
        const usersSnapshot = await getDocs(collection(db, "users"));
        usersSnapshot.forEach((doc) => {
            userProfiles[doc.id] = doc.data();
        });
    } catch (error) {
        console.error("Error fetching user profiles: ", error);
    }

    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const currentUserEmail = localStorage.getItem('userEmail');

    const q = query(collection(db, "chat_messages"), orderBy("timestamp"));
    unsubscribeChat = onSnapshot(q, (querySnapshot) => {
        messagesContainer.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const msg = doc.data();
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper');
            wrapper.dataset.messageId = doc.id;

            if (msg.senderEmail === currentUserEmail) {
                wrapper.classList.add('own-message');
            }

            const firestoreProfile = userProfiles[msg.senderEmail];
            
            const localProfileKey = `movieflix-profile-${msg.senderEmail}`;
            const localProfileData = JSON.parse(localStorage.getItem(localProfileKey));

            const senderName = firestoreProfile?.nickname || localProfileData?.nickname || msg.senderEmail.split('@')[0];
            const senderAvatar = firestoreProfile?.avatar || localProfileData?.avatar || `https://picsum.photos/seed/${msg.senderEmail}/32/32.jpg`;

            wrapper.innerHTML = `
                <img class="message-avatar" src="${senderAvatar}" alt="${senderName}">
                <div class="message-content">
                    <div class="message-item" data-message-id="${doc.id}" data-message-text="${msg.text}">
                        <div class="sender">${senderName}</div>
                        <div>${msg.text}</div>
                    </div>
                </div>
                ${msg.senderEmail === currentUserEmail ? `
                    <div class="message-options" id="options-${doc.id}">
                        <div class="message-option edit" onclick="openEditMessageModal('${doc.id}', '${msg.text.replace(/'/g, "\\'")}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </div>
                        <div class="message-option delete" onclick="deleteMessage('${doc.id}')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </div>
                    </div>
                ` : ''}
            `;

            if (msg.senderEmail === currentUserEmail) {
                const messageItem = wrapper.querySelector('.message-item');
                messageItem.addEventListener('touchstart', (e) => {
                    touchStartTime = new Date().getTime();
                    longPressTimer = setTimeout(() => { toggleMessageOptions(doc.id); }, 500);
                });
                messageItem.addEventListener('touchend', (e) => {
                    const touchEndTime = new Date().getTime();
                    if (touchEndTime - touchStartTime < 500) { clearTimeout(longPressTimer); }
                });
                messageItem.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                messageItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    toggleMessageOptions(doc.id);
                });
            }
            messagesContainer.appendChild(wrapper);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text) {
            try {
                await addDoc(collection(db, "chat_messages"), { text, senderEmail: currentUserEmail, timestamp: serverTimestamp() });
                messageInput.value = '';
            } catch (error) { console.error("Error sending message: ", error); }
        }
    });
};
    window.toggleMessageOptions = (messageId) => {
        const optionsMenu = document.getElementById(`options-${messageId}`);
        if (optionsMenu) {
            document.querySelectorAll('.message-options.active').forEach(el => {
                if (el.id !== `options-${messageId}`) {
                    el.classList.remove('active');
                }
            });
            
            optionsMenu.classList.toggle('active');
        }
    };

    window.openEditMessageModal = (messageId, messageText) => {
        editingMessageId = messageId;
        document.getElementById('editMessageInput').value = messageText;
        editMessageModal.classList.add('active');
        
        document.querySelectorAll('.message-options.active').forEach(el => {
            el.classList.remove('active');
        });
    };

    window.closeEditMessageModal = () => {
        editMessageModal.classList.remove('active');
        editingMessageId = null;
    };

    window.saveEditedMessage = async () => {
        const newText = document.getElementById('editMessageInput').value.trim();
        if (!newText || !editingMessageId) return;
        
        try {
            const messageRef = doc(db, "chat_messages", editingMessageId);
            await updateDoc(messageRef, { text: newText });
            closeEditMessageModal();
        } catch (error) {
            console.error("Error updating message: ", error);
            alert("Failed to update message. Please try again.");
        }
    };

    window.deleteMessage = async (messageId) => {
        if (!confirm("Are you sure you want to delete this message?")) return;
        
        try {
            const messageRef = doc(db, "chat_messages", messageId);
            await deleteDoc(messageRef);
            
            document.querySelectorAll('.message-options.active').forEach(el => {
                el.classList.remove('active');
            });
        } catch (error) {
            console.error("Error deleting message: ", error);
            alert("Failed to delete message. Please try again.");
        }
    };

    window.resumePlayback = function() {
        const resumeData = JSON.parse(localStorage.getItem('movieflix-continue-watching'));
        if(resumeData) {
            showDetailView(resumeData.itemId, resumeData.type, resumeData);
        }
    }

    window.handleMyListToggle = (itemId) => {
        const currentUserEmail = localStorage.getItem('userEmail');
        if (!currentUserEmail) {
            alert("Please log in to add items to your list.");
            return;
        }
        const storageKey = `movieflix-mylist-${currentUserEmail}`;
        let myList = JSON.parse(localStorage.getItem(storageKey)) || [];
        const itemIndex = myList.indexOf(itemId);

        const button = document.getElementById('mylist-btn');
        const icon = button.querySelector('i');

        if (itemIndex > -1) {
            myList.splice(itemIndex, 1);
            button.classList.remove('active');
            icon.className = 'fas fa-plus';
        } else {
            myList.push(itemId);
            button.classList.add('active');
            icon.className = 'fas fa-check';
        }
        localStorage.setItem(storageKey, JSON.stringify(myList));
    };

    window.handleLike = async (itemId, type, isDislike = false) => {
    const currentUserEmail = localStorage.getItem('userEmail');
    if (!currentUserEmail) {
        alert("You must be logged in to like or dislike.");
        return;
    }

    let localData;
    if (type === 'tv') {
        localData = allTvChannels.find(i => i.id === itemId);
    } else {
        localData = allContent.find(i => i.id === itemId);
    }
    
    if (!localData) return;

    const storageKey = `movieflix-actions-${currentUserEmail}`;
    const userActions = JSON.parse(localStorage.getItem(storageKey)) || {};
    const currentAction = userActions[itemId];

    const actionType = isDislike ? 'disliked' : 'liked';
    const oppositeActionType = isDislike ? 'liked' : 'disliked';

    const dbUpdates = {};
    let newActionState = actionType;

    localData.likes = Number(localData.likes) || 0;
    localData.dislikes = Number(localData.dislikes) || 0;

    if (currentAction === oppositeActionType) {
        dbUpdates[isDislike ? 'likes' : 'dislikes'] = increment(-1);
        dbUpdates[isDislike ? 'dislikes' : 'likes'] = increment(1);
        localData[isDislike ? 'likes' : 'dislikes']--;
        localData[isDislike ? 'dislikes' : 'likes']++;
    }
    else if (currentAction === actionType) {
        dbUpdates[isDislike ? 'dislikes' : 'likes'] = increment(-1);
        localData[isDislike ? 'dislikes' : 'likes']--;
        newActionState = null;
    }
    else {
        dbUpdates[isDislike ? 'dislikes' : 'likes'] = increment(1);
        localData[isDislike ? 'dislikes' : 'likes']++;
    }

    if (newActionState) {
        userActions[itemId] = newActionState;
    } else {
        delete userActions[itemId];
    }
    localStorage.setItem(storageKey, JSON.stringify(userActions));

    const likesCountEl = document.getElementById('likes-count');
    const dislikesCountEl = document.getElementById('dislikes-count');
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    
    if (likesCountEl) likesCountEl.textContent = localData.likes;
    if (dislikesCountEl) dislikesCountEl.textContent = localData.dislikes;
    if (likeBtn) likeBtn.classList.toggle('active', userActions[itemId] === 'liked');
    if (dislikeBtn) dislikeBtn.classList.toggle('active', userActions[itemId] === 'disliked');

    try {
        const itemRef = doc(db, "likes", itemId);
        await setDoc(itemRef, dbUpdates, { merge: true });
    } catch (error) {
        console.error("Error updating reaction in Firestore: ", error);
    }
};

window.showDownloadOptions = (links) => {
        const overlay = document.createElement('div');
        overlay.id = 'download-modal-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
        overlay.style.zIndex = '3000';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.onclick = () => document.body.removeChild(overlay);

        const modal = document.createElement('div');
        modal.style.background = '#1f212a';
        modal.style.padding = '20px';
        modal.style.borderRadius = '8px';
        modal.style.minWidth = '300px';
        modal.style.maxWidth = '90%';
        modal.style.textAlign = 'center';
        modal.onclick = (e) => e.stopPropagation();

        const title = document.createElement('h2');
        title.innerText = 'Select Download Quality';
        title.style.color = 'white';
        title.style.marginTop = '0';
        modal.appendChild(title);

        for (const quality in links) {
            const link = document.createElement('a');
            link.href = links[quality];
            link.target = '_blank';
            link.innerText = `Download ${quality.toUpperCase()}`;
            link.style.display = 'block';
            link.style.padding = '12px';
            link.style.margin = '10px 0';
            link.style.backgroundColor = 'var(--netflix-red)';
            link.style.color = 'white';
            link.style.textDecoration = 'none';
            link.style.borderRadius = '5px';
            link.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(link);
        }

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    };
    window.playTrailer = (trailerId) => {
        if (!trailerId) {
            alert("Trailer not available");
            return;
        }
        
        trailerModal.classList.add('active');
        
        const trailerPlayerDiv = document.getElementById('trailerPlayer');
        trailerPlayerDiv.innerHTML = `
            <iframe 
                width="100%" 
                height="100%" 
                src="https://www.youtube.com/embed/${trailerId}?autoplay=1&rel=0&modestbranding=1" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        `;
    };
    
    window.closeTrailerModal = () => {
        trailerModal.classList.remove('active');
        document.getElementById('trailerPlayer').innerHTML = '';
    };

    function extractSeasonNumber(title) {
        if (!title) return 1;
        
        const seasonMatch = title.match(/season\s*(\d+)|s(\d+)|series\s*(\d+)/i);
        if (seasonMatch) {
            return parseInt(seasonMatch[1] || seasonMatch[2] || seasonMatch[3], 10);
        }
        
        return 1;
    }

    const showDetailView = (itemId, type, autoplayInfo = null) => {
        document.getElementById('appHeader').classList.add('header-solid');
        document.getElementById('backButton').style.display = 'flex';

        appHeader.style.display = 'flex';
        if (player) { player.destroy(); player = null; }
        if (hls) { hls.destroy(); hls = null; }
        if (networkQualityInterval) clearInterval(networkQualityInterval);

        let itemFromSheet;
        if (type === 'tv') {
            itemFromSheet = allTvChannels.find(i => i.id === itemId);
        } else {
            itemFromSheet = allContent.find(i => i.id === itemId);
        }

        if (!itemFromSheet) {
            console.error("Item not found:", itemId, type);
            appHeader.style.display = 'flex';
            return;
        }
        
        const item = { ...itemFromSheet };
        item.likes = item.likes || 0;
        item.dislikes = item.dislikes || 0;
        
        let episodes = [];
        if (item.episodes && typeof item.episodes === 'string') {
            try { episodes = JSON.parse(item.episodes); } catch (e) { console.error("Error parsing episodes JSON:", e); episodes = []; }
        }

        const currentUserEmail = localStorage.getItem('userEmail');
        const actionsStorageKey = `movieflix-actions-${currentUserEmail}`;
        const userActions = currentUserEmail ? (JSON.parse(localStorage.getItem(actionsStorageKey)) || {}) : {};
        const currentAction = userActions[itemId];

        const myListStorageKey = `movieflix-mylist-${currentUserEmail}`;
        const myList = currentUserEmail ? (JSON.parse(localStorage.getItem(myListStorageKey)) || []) : [];
        const isInMyList = myList.includes(itemId);

        const firstEpisode = episodes[0] || {};

        const contentDetailsForPlay = { url: item.movielink || firstEpisode.url || item.streamurl, title: item.title || item.name, episodeTitle: firstEpisode.title || null, itemId: item.id, type: item.type, posterUrl: item.posterurl || item.logourl };

        const playAction = `playContent(${JSON.stringify(contentDetailsForPlay).replace(/"/g, "'")}, 0)`;
        
        // Add rating to hero content
        const ratingDisplay = item.rating ? ` • ${item.rating}` : '';
        const heroContent = `<div class="hero-content"><h1>${item.title || item.name}</h1><p>${item.category || 'Live TV'}${ratingDisplay}</p><button class="play-button-main" onclick="${playAction}"><i class="fas fa-play"></i>Play</button></div>`;

        const downloadLinks = {};
        for (const key in item) {
            if (key.startsWith('download') && key.length > 8 && item[key]) {
                const quality = key.replace('download', '');
                downloadLinks[quality] = item[key];
            }
        }
        const downloadOptionsString = JSON.stringify(downloadLinks).replace(/"/g, "'");

        const actionsBarHtml = `
        <div class="actions-bar">
            <div class="action-buttons-container">
                <button id="mylist-btn" class="action-btn ${isInMyList ? 'active' : ''}" onclick="handleMyListToggle('${item.id}')">
                    <i class="${isInMyList ? 'fas fa-check' : 'fas fa-plus'}"></i>
                    <span>My List</span>
                </button>
                <button id="like-btn" class="action-btn ${currentAction === 'liked' ? 'active' : ''}" onclick="handleLike('${item.id}', '${item.type}')">
                    <i class="fas fa-thumbs-up"></i>
                    <span id="likes-count">${item.likes || 0}</span>
                </button>
                <button id="dislike-btn" class="action-btn ${currentAction === 'disliked' ? 'active' : ''}" onclick="handleLike('${item.id}', '${item.type}', true)">
                    <i class="fas fa-thumbs-down"></i>
                    <span id="dislikes-count">${item.dislikes || 0}</span>
                </button>
                ${Object.keys(downloadLinks).length > 0 ? `
                <button id="download-btn" class="action-btn" onclick="showDownloadOptions(${downloadOptionsString})">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </button>` : ''}
            </div>
            <div class="detail-ad-container" id="detailAdContainer"></div>
        </div>`;

        const episodesHtml = episodes.map((ep, index) => { 
            const posterUrl = ep.img || item.posterurl || 'https://via.placeholder.com/160x90.png?text=No+Image';
            const episodeCardHtml = `
                
    <div class="episode-card" id="episode-card-${index}" onclick="playContent(${JSON.stringify({ ...contentDetailsForPlay, url: ep.url, episodeTitle: ep.title }).replace(/"/g, "'")}, ${index})">  
                       <div class="episode-card-poster">
                        <img src="${posterUrl}" alt="${ep.title}" loading="lazy">
                        <div class="episode-play-icon">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="episode-card-title">${ep.title}</div>
                </div>
            `;
            return `<div class="swiper-slide">${episodeCardHtml}</div>`;
        }).join('');

        const recommendations = getMoreLikeThis(item);
        let recommendationsHtml = '';
        if (recommendations.length > 0) {
            recommendationsHtml = `
                <div class="up-next-section">
                    <div class="category-title" style="padding-right:0;">
                         <div class="category-title-left">
                            <div class="category-title-bar"></div>
                            <h2>More Like This</h2>
                        </div>
                    </div>
                    <div class="content-grid" style="padding-left:0; padding-right:0;">
                        ${recommendations.map(rec => createContentCard(rec, true)).join('')}
                    </div>
                </div>
            `;
            
            setTimeout(() => setupLazyLoading(), 100);
        }
        
        let trailerHtml = '';
        if (item.trailerid) {
            trailerHtml = `
                <div class="trailer-section active" id="trailerSection">
                    <h2>Trailer</h2>
                    <div class="trailer-container" onclick="playTrailer('${item.trailerid}')">
                        <img class="trailer-thumbnail" src="https://img.youtube.com/vi/${item.trailerid}/maxresdefault.jpg" alt="Trailer Thumbnail">
                        <div class="trailer-play-overlay">
                            <div class="trailer-play-button">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="trailer-title">Watch Trailer</div>
                    </div>
                </div>
            `;
        }

        const seasonNumber = extractSeasonNumber(item.title || item.name);

        mainContent.innerHTML = `<div class="detail-view-container">
            <div id="player-container" style="background-image: url('${item.posterurl || item.logourl}')">${heroContent}</div>
            <div class="detail-body-content">
                ${item.description ? `<p class="detail-description">${item.description}</p>` : ''}
                ${actionsBarHtml}
                ${trailerHtml}
                ${(episodes.length > 0) ? `
                    <div id="episodes-section">
                        <h2>Season ${seasonNumber}</h2>
                        <div class="swiper-container episodes-swiper">
                            <div class="swiper-wrapper">${episodesHtml}</div>
                        </div>
                    </div>
                ` : ''}
                ${recommendationsHtml}
            </div>
        </div>`;

        if (episodes.length > 0) {
            new Swiper('.episodes-swiper', {
                slidesPerView: 'auto',
                spaceBetween: 15,
                freeMode: true,
            });
        }

        if (autoplayInfo) { playContent(autoplayInfo, autoplayInfo.currentTime); }
        window.scrollTo(0, 0);

        getDoc(doc(db, "likes", itemId)).then(likeDocSnap => {
            if (likeDocSnap.exists()) {
                const likeData = likeDocSnap.data();
                const latestLikes = likeData.likes || 0;
                const latestDislikes = likeData.dislikes || 0;
                
                Object.assign(itemFromSheet, { likes: latestLikes, dislikes: latestDislikes });

                const likesCountEl = document.getElementById('likes-count');
                const dislikesCountEl = document.getElementById('dislikes-count');
                if (likesCountEl) likesCountEl.textContent = latestLikes;
                if (dislikesCountEl) dislikesCountEl.textContent = latestDislikes;
            }
        }).catch(error => {
            console.error("Failed to fetch latest like counts:", error);
        });
    };

    // AUTOPLAY FEATURE FUNCTION
    function showAutoplayCountdown(nextContent, contentType) {
        let countdown = 10; // 10 seconds countdown
        
        // Remove any existing autoplay overlay
        const existingOverlay = document.getElementById('autoplay-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        // Autoplay countdown UI create karo
        const autoplayOverlay = document.createElement('div');
        autoplayOverlay.id = 'autoplay-overlay';
        
        // Next content ka poster aur info
        const posterUrl = nextContent.posterUrl || nextContent.posterurl || 'https://picsum.photos/seed/next/80/120.jpg';
        const title = nextContent.title || nextContent.name;
        const episodeTitle = nextContent.episodeTitle || '';
        
        autoplayOverlay.innerHTML = `
            <img src="${posterUrl}" alt="${title}" loading="lazy">
            <div class="autoplay-info">
                <div class="autoplay-title">${contentType === 'episode' ? 'Next Episode' : 'Up Next'}</div>
                <div class="autoplay-subtitle">${title}</div>
                ${episodeTitle ? `<div class="autoplay-subtitle">${episodeTitle}</div>` : ''}
                <div class="autoplay-timer">Playing in <span id="countdown-timer">${countdown}</span> seconds</div>
            </div>
            <button id="cancel-autoplay">×</button>
        `;
        
        document.body.appendChild(autoplayOverlay);
        
        // Countdown timer
        const countdownInterval = setInterval(() => {
            countdown--;
            const timerElement = document.getElementById('countdown-timer');
            if (timerElement) {
                timerElement.textContent = countdown;
            }
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                if (document.body.contains(autoplayOverlay)) {
                    document.body.removeChild(autoplayOverlay);
                }
                
                // Next content play karo
                if (contentType === 'episode') {
                    playContent(nextContent);
                } else {
                    showDetailView(nextContent.id, nextContent.type);
                    setTimeout(() => {
                        const playButton = document.querySelector('.play-button-main');
                        if (playButton) {
                            playButton.click();
                        }
                    }, 1000);
                }
            }
        }, 1000);
        
        // Cancel button
        const cancelBtn = document.getElementById('cancel-autoplay');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                clearInterval(countdownInterval);
                if (document.body.contains(autoplayOverlay)) {
                    document.body.removeChild(autoplayOverlay);
                }
            });
        }
    }

    window.playContent = (contentDetails, episodeIndex = null, startTime = 0) => { 
    document.querySelectorAll('.episode-card').forEach(card => card.classList.remove('playing-now'));
    if (episodeIndex !== null) {
        const currentEpisodeCard = document.getElementById(`episode-card-${episodeIndex}`);
        if (currentEpisodeCard) currentEpisodeCard.classList.add('playing-now');
    }

    if (!contentDetails.url) { alert("Video content not available."); return; }
    activeContentDetails = contentDetails;
    const playerContainer = document.getElementById('player-container');
    if (!playerContainer) { console.error("Player container not found!"); return; }
    if (player) player.destroy();
    if (hls) hls.destroy();
    if (networkQualityInterval) clearInterval(networkQualityInterval);

    isMoviePlaying = true;
    const trailerSection = document.getElementById('trailerSection');
    if (trailerSection) trailerSection.classList.remove('active');

    document.getElementById('headerMenuBtn').style.display = 'none';
    document.getElementById('headerBackBtn').style.display = 'flex';

    playerContainer.classList.add('playing');

    // Autoplay state variable
    let autoplayEnabled = localStorage.getItem('movieflix-autoplay') !== 'false'; // Default to true

playerContainer.innerHTML = `
    <div class="player-wrapper">
         <div class="gesture-feedback-overlay">
            <div class="feedback-indicator" id="feedbackIndicator"></div>
        </div>
        <div class="brightness-overlay" id="brightnessOverlay"></div>
        <div class="player-nav-header">
 
                <i class="fas fa-arrow-left"></i>
            </button>
         
            <div class="network-quality" id="networkQuality">
                <i class="fas fa-wifi"></i>
                <span id="networkSpeed">Checking...</span>
            </div>
           </div>
        <div class="buffering-indicator" id="bufferingIndicator">
            <div class="buffering-spinner"></div>
        </div>
        <video id="videoPlayer" playsinline controls crossorigin="anonymous"></video>
    </div>`;
        playerContainer.style.backgroundImage = 'none';

        const video = document.getElementById('videoPlayer');
        const bufferingIndicator = document.getElementById('bufferingIndicator');
        const networkQualityEl = document.getElementById('networkQuality');
        const networkSpeedEl = document.getElementById('networkSpeed');
        
        const updateNetworkQuality = () => {
            if (!navigator.connection) return;
            
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (!connection) return;
            
            let quality = 'good';
            let speedText = 'Good';
            
            if (connection.downlink < 1.5) {
                quality = 'poor';
                speedText = 'Poor';
            } else if (connection.downlink < 5) {
                quality = 'medium';
                speedText = 'Medium';
            }
            
            networkQualityEl.className = `network-quality ${quality}`;
            networkSpeedEl.textContent = speedText;
        };
        
        updateNetworkQuality();
        networkQualityInterval = setInterval(updateNetworkQuality, 5000);
        
        bufferingIndicator.classList.add('active');
        
        if (Hls.isSupported() && contentDetails.url.includes('.m3u8')) {
            hls = new Hls({
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
                maxBufferSize: 60 * 1000 * 1000,
                maxBufferHole: 0.5,
                liveSyncDurationCount: 3,
                liveMaxLatencyDurationCount: Infinity,
                liveDurationInfinity: true,
                abrEwmaDefaultEstimate: 500000,
                abrEwmaSlowVoD: 4,
                abrEwmaFastVoD: 3,
                abrEwmaDefaultEstimate: 500000,
                startLevel: -1,
                autoStartLoad: true,
                fragLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 6,
                fragLoadingRetryDelay: 1000,
                manifestLoadingTimeOut: 10000,
                manifestLoadingMaxRetry: 4,
                manifestLoadingRetryDelay: 1000,
                levelLoadingTimeOut: 10000,
                levelLoadingMaxRetry: 4,
                levelLoadingRetryDelay: 1000,
                audioTrackSwitching: true,
                audioTrackSwitchingDelay: 0.1,
                capLevelToPlayerSize: true,
                enableWorker: true,
                workerPath: null,
                lowLatencyMode: true,
                backBufferLength: 90
            });
            
            hls.loadSource(contentDetails.url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                console.log('Manifest parsed, available quality levels:', data.levels);
            });
            
            hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                const level = hls.levels[data.level];
                console.log('Switched to quality level:', level.height + 'p', level.bitrate + ' bps');
            });
            
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.error('HLS error:', data);
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Fatal network error, trying to recover...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Fatal media error, trying to recover...');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.error('Fatal error, cannot recover');
                            break;
                    }
                }
            });
            
            hls.on(Hls.Events.FRAG_BUFFERED, function() {
                bufferingIndicator.classList.remove('active');
            });
            
        } else {
            video.src = contentDetails.url;
            
            video.addEventListener('canplay', function() {
                bufferingIndicator.classList.remove('active');
            });
            
            video.addEventListener('waiting', function() {
                bufferingIndicator.classList.add('active');
            });
            
            video.addEventListener('playing', function() {
                bufferingIndicator.classList.remove('active');
            });
        }

        player = new Plyr(video, {
            autoplay: true,
            tooltips: { controls: true, seek: true },
            controls: [
                'play-large', 'restart', 'rewind', 'play', 'fast-forward', 'progress',
                'current-time', 'duration', 'mute', 'volume', 'captions', 'settings',
                'pip', 'airplay', 'fullscreen'
            ],
            settings: ['captions', 'quality', 'speed', 'loop'],
            hideControlsOnPause: false,
            resetOnEnd: true,
            clickToPlay: true,
            disableContextMenu: false,
            seekTime: 10,
            invertTime: false,
            toggleInvert: false,
        });

        // Add autoplay toggle button to player controls
        setTimeout(() => {
            const controlsContainer = document.querySelector('.plyr__controls');
            if (controlsContainer && !document.getElementById('autoplay-toggle')) {
                const autoplayToggle = document.createElement('div');
                autoplayToggle.id = 'autoplay-toggle';
                autoplayToggle.className = 'plyr__control plyr__control--forward plyr__autoplay-toggle';
                autoplayToggle.innerHTML = `
                    <span class="plyr__tooltip" role="tooltip">Autoplay</span>
                    <div class="plyr__autoplay-toggle-container">
                        <span class="plyr__autoplay-label">Autoplay</span>
                        <div class="plyr__autoplay-switch ${autoplayEnabled ? 'plyr__autoplay-switch--on' : ''}">
                            <div class="plyr__autoplay-toggle-handle"></div>
                        </div>
                    </div>
                `;
                
                // Insert before the fullscreen button
                const fullscreenBtn = controlsContainer.querySelector('[data-plyr="fullscreen"]');
                if (fullscreenBtn) {
                    controlsContainer.insertBefore(autoplayToggle, fullscreenBtn);
                } else {
                    controlsContainer.appendChild(autoplayToggle);
                }
                
                // Add click event to toggle autoplay
                autoplayToggle.addEventListener('click', () => {
                    autoplayEnabled = !autoplayEnabled;
                    localStorage.setItem('movieflix-autoplay', autoplayEnabled);
                    
                    const switchElement = autoplayToggle.querySelector('.plyr__autoplay-switch');
                    if (autoplayEnabled) {
                        switchElement.classList.add('plyr__autoplay-switch--on');
                    } else {
                        switchElement.classList.remove('plyr__autoplay-switch--on');
                    }
                });
            }
        }, 500);

        player.on('enterfullscreen', async () => {
            try {
                setTimeout(() => {
                    if (video) {
                        video.style.width = '100%';
                        video.style.height = '100%';
                    }
                }, 100);
                
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                }
            } catch (err) {
                console.error('Failed to lock orientation:', err);
            }
        });

        player.on('exitfullscreen', () => {
            if (video) {
                video.style.width = '';
                video.style.height = '';
            }
            
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            }
        });

        player.once('canplay', () => {
            if (startTime > 0 && player.duration && startTime < player.duration) {
                player.currentTime = startTime;
            }
        });

        player.on('timeupdate', () => {
            if (player && player.currentTime > 5 && player.duration) {
                const progress = {
                    ...activeContentDetails,
                    currentTime: player.currentTime,
                    duration: player.duration
                };
                if ((progress.currentTime / progress.duration) < 0.95) {
                    localStorage.setItem('movieflix-continue-watching', JSON.stringify(progress));
                }
            }
        });

        // AUTOPLAY FEATURE - MODIFIED ENDED EVENT
        player.on('ended', () => {
            // Continue watching data remove kar rahe hain
            const savedData = JSON.parse(localStorage.getItem('movieflix-continue-watching'));
            if (savedData && savedData.itemId === activeContentDetails.itemId) {
                localStorage.removeItem('movieflix-continue-watching');
            }
            
            // Check if autoplay is enabled before showing countdown
            if (autoplayEnabled) {
                // Autoplay feature start yahan se
                if (activeContentDetails.type === 'movie') {
                    // Movie ke case mein related movie play karo
                    const recommendations = getMoreLikeThis(activeContentDetails);
                    if (recommendations.length > 0) {
                        showAutoplayCountdown(recommendations[0], 'movie');
                    }
                } else if (activeContentDetails.type === 'series' || activeContentDetails.type === 'animation') {
                    // Series/animation ke case mein next episode dhundo
                    const item = allContent.find(i => i.id === activeContentDetails.itemId);
                    if (item && item.episodes) {
                        let episodes = [];
                        try {
                            episodes = JSON.parse(item.episodes);
                        } catch (e) {
                            console.error("Error parsing episodes JSON:", e);
                        }
                        
                        // Current episode index dhundo
                        const currentEpisodeIndex = episodes.findIndex(ep => ep.url === activeContentDetails.url);
                        
                        // Agar next episode available hai
                        if (currentEpisodeIndex !== -1 && currentEpisodeIndex < episodes.length - 1) {
                            const nextEpisode = episodes[currentEpisodeIndex + 1];
                            const nextEpisodeDetails = {
                                ...activeContentDetails,
                                url: nextEpisode.url,
                                episodeTitle: nextEpisode.title
                            };
                            showAutoplayCountdown(nextEpisodeDetails, 'episode');
                        } else {
                            // Agar series khatam ho gayi to related series play karo
                            const recommendations = getMoreLikeThis(activeContentDetails);
                            if (recommendations.length > 0) {
                                showAutoplayCountdown(recommendations[0], 'series');
                            }
                        }
                    }
                }
            }
            
            // Original functionality
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen();
            }
            if(screen.orientation && screen.orientation.unlock){
                screen.orientation.unlock();
            }
            
            isMoviePlaying = false;
            
            const trailerSection = document.getElementById('trailerSection');
            if (trailerSection) {
                trailerSection.classList.add('active');
            }
        });

        setupGestureControls(player, playerContainer);
    };

    function setupGestureControls(playerInstance, container) {
        const indicator = container.querySelector('#feedbackIndicator');
        const brightnessOverlay = container.querySelector('#brightnessOverlay');
        let touchStartX, touchStartY;
        let lastTapTime = 0;
        let tapTimeout = null;

        const showFeedback = (text) => {
            indicator.textContent = text;
            indicator.style.opacity = '1';
            setTimeout(() => { indicator.style.opacity = '0'; }, 800);
        };

        container.addEventListener('touchstart', (e) => {
            if (playerInstance.fullscreen.active && e.touches.length === 1) {
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
            }
        }, { passive: true });

        container.addEventListener('touchmove', (e) => {
            if (!playerInstance.fullscreen.active || e.touches.length !== 1) return;
            e.preventDefault();

            const touch = e.touches[0];
            const deltaY = touchStartY - touch.clientY;
            const deltaX = touchStartX - touch.clientX;

            if (Math.abs(deltaY) > Math.abs(deltaX) * 2) {
                const halfScreenWidth = window.innerWidth / 2;
                if (touch.clientX < halfScreenWidth) {
                    const brightnessChange = deltaY / (window.innerHeight / 2);
                    let currentBrightness = parseFloat(brightnessOverlay.style.opacity) || 0;
                    let newBrightness = Math.max(0, Math.min(0.7, currentBrightness - brightnessChange));
                    brightnessOverlay.style.opacity = newBrightness;
                    showFeedback(`🔆 ${Math.round((0.7-newBrightness)/0.7 * 100)}%`);
                } else {
                    const volumeChange = deltaY / window.innerHeight;
                    playerInstance.volume = Math.max(0, Math.min(1, playerInstance.volume + volumeChange));
                    showFeedback(`🔊 ${Math.round(playerInstance.volume * 100)}%`);
                }
                touchStartY = touch.clientY;
            }
        });

        container.addEventListener('touchend', (e) => {
            if (!playerInstance.fullscreen.active) return;

            const currentTime = new Date().getTime();
            const tapDuration = currentTime - lastTapTime;
            lastTapTime = currentTime;

            clearTimeout(tapTimeout);

            if (tapDuration < 300 && tapDuration > 0) {
                e.preventDefault();
                const halfScreenWidth = window.innerWidth / 2;
                if (touchStartX < halfScreenWidth) {
                    playerInstance.rewind(10);
                    showFeedback('⏪ 10s');
                } else {
                    playerInstance.forward(10);
                    showFeedback('⏩ 10s');
                }
            } else {
                tapTimeout = setTimeout(() => {
                    if (!playerInstance.controls.pressed) {
                        playerInstance.togglePlay();
                    }
                }, 300);
            }
        });
    }

    window.goBack = () => {
        document.getElementById('headerMenuBtn').style.display = 'flex';
        document.getElementById('headerBackBtn').style.display = 'none';
        
        if (player) {
            player.destroy();
            player = null;
        }
        if (hls) {
            hls.destroy();
            hls = null;
        }
        if (networkQualityInterval) {
            clearInterval(networkQualityInterval);
        }
        if (screen.orientation && screen.orientation.unlock) {
            screen.orientation.unlock();
        }
        
        isMoviePlaying = false;
        
        const trailerSection = document.getElementById('trailerSection');
        if (trailerSection) {
            trailerSection.classList.add('active');
        }
        
        showDetailView(activeContentDetails.itemId, activeContentDetails.type);
    };
    window.showDetailView = showDetailView;
    
    // UPDATED createContentCard function with rating and badge
    const createContentCard = (item, isGridItem = false, isFromSearch = false) => {
        const isAvailable =
            (item.type === 'movie' && item.movielink) ||
            ((item.type === 'series' || item.type === 'animation') && item.episodes && item.episodes.trim() !== '' && item.episodes.trim() !== '[]') ||
            (item.type === 'tv' && item.streamurl);

        let action = isAvailable ? `showDetailView('${item.id}', '${item.type}')` : '';
        if (isAvailable && isFromSearch) {
            action = `closeSearchOverlay(); showDetailView('${item.id}', '${item.type}')`;
        }
        const comingSoonClass = isAvailable ? '' : 'coming-soon';
        const comingSoonOverlay = isAvailable ? '' : '<div class="coming-soon-overlay">Coming Soon</div>';

        // Extract rating if available
        let ratingHtml = '';
        if (item.rating) {
            ratingHtml = `
                <div class="content-card-rating">
                    <span class="rating-star">★</span>
                    <span>${item.rating}</span>
                </div>
            `;
        }

        // Extract quality badge if available
        let badgeHtml = '';
        if (item.quality && item.quality.toLowerCase() === 'hd') {
            badgeHtml = '<div class="content-card-badge">HD</div>';
        }

        const cardInnerHtml = `
            <div class="content-card ${comingSoonClass}" ${action ? `onclick="${action}"` : ''}>
                <img class="lazy-image" data-src="${item.posterurl || item.logourl}" src="https://picsum.photos/seed/loading/160/240.jpg" alt="${item.title || item.name}">
                
                <!-- IMAGE KE BAAD YAHAN PE ADD KIYA GAYA HAI -->
                ${badgeHtml}
                ${ratingHtml}
                
                ${comingSoonOverlay}
                <div class="content-card-info">
                    <div class="content-card-title">${item.title || item.name}</div>
                </div>
            </div>`;

        if (isGridItem) {
            return cardInnerHtml;
        } else {
            return `<div class="swiper-slide">${cardInnerHtml}</div>`;
        }
    };

    const createTvCard = (channel) => {
        const cardHtml = `<div class="tv-card" onclick="showDetailView('${channel.id}', 'tv')"><img class="lazy-image" data-src="${channel.logourl}" src="https://picsum.photos/seed/loading/120/80.jpg" alt="${channel.name}"><div class="tv-card-title">${channel.name}</div></div>`;
        return `<div class="swiper-slide">${cardHtml}</div>`;
    }

    const getMoreLikeThis = (currentItem) => {
        let recommendations = [];
        if (currentItem.category) {
            const currentCategories = currentItem.category.split(',').map(c => c.trim().toLowerCase());
            let sourceList = (currentItem.type === 'tv') ? allTvChannels : allContent;

            recommendations = sourceList.filter(item => {
                if (item.id === currentItem.id) return false;
                const itemCategories = item.category ? item.category.split(',').map(c => c.trim().toLowerCase()) : [];
                return itemCategories.some(cat => currentCategories.includes(cat));
            });
        }
        const needed = 10 - recommendations.length;
        if (needed > 0) {
            const otherItems = allContent.filter(item => item.id !== currentItem.id && !recommendations.find(rec => rec.id === item.id));
            recommendations.push(...otherItems.sort(() => 0.5 - Math.random()).slice(0, needed));
        }
        return recommendations.slice(0, 10);
    };

    const initializeAppView = async () => {
        try {
            showLoadingState();
            
            if (!navigator.onLine) {
                throw new Error('No internet connection');
            }
            
            const cachedMovies = cacheManager.get('Movies');
            const cachedSeries = cacheManager.get('Series');
            const cachedAnimations = cacheManager.get('Animations');
            const cachedTv = cacheManager.get('TV');
            const cachedHomepage = cacheManager.get('Homepage');
            const cachedSettings = cacheManager.get('Settings');
            
            if (cachedMovies && cachedSeries && cachedAnimations && cachedTv) {
                let tempAllMovies = cachedMovies.map(item => ({ ...item, type: 'movie' }));
                let tempAllSeries = cachedSeries.map(item => ({ ...item, type: 'series' }));
                let tempAllAnimations = cachedAnimations.map(item => ({ ...item, type: 'animation' }));
                let tempAllTvChannels = cachedTv.map(item => ({ ...item, type: 'tv' }));

                const isVisible = (item) => item.show?.toLowerCase() !== 'false';

                allMovies = tempAllMovies.filter(isVisible);
                allSeries = tempAllSeries.filter(isVisible);
                allAnimations = tempAllAnimations.filter(isVisible);
                allTvChannels = tempAllTvChannels.filter(isVisible);
                allContent = [...allMovies, ...allSeries, ...allAnimations];

                if (cachedHomepage) {
                    cachedHomepage.forEach(item => {
                        if (item.id && item.imageurl) {
                            homepageCategoryImages[item.id.toLowerCase()] = item.imageurl;
                        }
                    });
                }

                if (cachedSettings && cachedSettings.length > 0) {
                    const qrSetting = cachedSettings.find(setting => setting.key && setting.key.trim() === 'qr_image_url');
                    if (qrSetting && qrSetting.value) {
                        qrCodeUrl = qrSetting.value;
                    }

                    const upiIdSetting = cachedSettings.find(setting => setting.key && setting.key.trim() === 'upi_id');
                    if (upiIdSetting && upiIdSetting.value) {
                        upiId = upiIdSetting.value;
                    }

                    const recipientNameSetting = cachedSettings.find(setting => setting.key && setting.key.trim() === 'recipient_name');
                    if (recipientNameSetting && recipientNameSetting.value) {
                        recipientName = recipientNameSetting.value;
                    }
                }
                
                showHomePage();
                
                setupSearchWithSuggestions();
                
                fetchFreshData();
            } else {
                await fetchFreshData();
            }
            
        } catch (error) {
            console.error("Error during initial data fetch: ", error);
            progressBar.classList.remove('active');
            
            if (error.message === 'No internet connection') {
                showError('No internet connection. Please check your network and try again.', 'initializeAppView()');
            } else {
                showError('Failed to load data. Please check your connection and try again.', 'initializeAppView()');
            }
        }
    };

    async function fetchFreshData() {
        try {
            const [moviesData, seriesData, animationsData, tvData, homepageCategoriesData, settingsData, updateData] = await Promise.all([
                fetchGoogleSheetData('Movies'),
                fetchGoogleSheetData('Series'),
                fetchGoogleSheetData('Animations'),
                fetchGoogleSheetData('TV'),
                fetchGoogleSheetData('Homepage'),
                fetchGoogleSheetData('Settings'),
                fetchGoogleSheetData('update_available')
            ]);

            let tempAllMovies = moviesData.map(item => ({ ...item, type: 'movie' }));
            let tempAllSeries = seriesData.map(item => ({ ...item, type: 'series' }));
            let tempAllAnimations = animationsData.map(item => ({ ...item, type: 'animation' }));
            let tempAllTvChannels = tvData.map(item => ({ ...item, type: 'tv' }));

            const isVisible = (item) => item.show?.toLowerCase() !== 'false';

            allMovies = tempAllMovies.filter(isVisible);
            allSeries = tempAllSeries.filter(isVisible);
            allAnimations = tempAllAnimations.filter(isVisible);
            allTvChannels = tempAllTvChannels.filter(isVisible);
            allContent = [...allMovies, ...allSeries, ...allAnimations];

            homepageCategoriesData.forEach(item => {
                if (item.id && item.imageurl) {
                    homepageCategoryImages[item.id.toLowerCase()] = item.imageurl;
                }
            });

            if (settingsData && settingsData.length > 0) {
                const qrSetting = settingsData.find(setting => setting.key && setting.key.trim() === 'qr_image_url');
                if (qrSetting && qrSetting.value) {
                    qrCodeUrl = qrSetting.value;
                }

                const upiIdSetting = settingsData.find(setting => setting.key && setting.key.trim() === 'upi_id');
                if (upiIdSetting && upiIdSetting.value) {
                    upiId = upiIdSetting.value;
                }

                const recipientNameSetting = settingsData.find(setting => setting.key && setting.key.trim() === 'recipient_name');
                if (recipientNameSetting && recipientNameSetting.value) {
                    recipientName = recipientNameSetting.value;
                }
            }

            checkForUpdates();
            
            setupSearchWithSuggestions();
            
            if (currentPageRender) {
                currentPageRender();
            } else {
                showHomePage();
            }
            
        } catch (error) {
            console.error("Error fetching fresh data: ", error);
            if (!currentPageRender) {
                showError('Failed to load data. Please try again.', 'initializeAppView()');
            }
        }
    }

    window.addEventListener('orientationchange', () => {
        if (player && player.fullscreen.active) {
            setTimeout(() => {
                const video = document.getElementById('videoPlayer');
                if (video) {
                    video.style.width = '100%';
                    video.style.height = '100%';
                }
            }, 300);
        }
    });
    
    window.addEventListener('click', (event) => {
        if (event.target === trailerModal) {
            closeTrailerModal();
        }
        if (event.target === avatarModal) {
            closeAvatarModal();
        }
        if (event.target === editMessageModal) {
            closeEditMessageModal();
        }
        if (event.target === document.getElementById('updatePopup')) {
            closeUpdatePopup();
        }
    });
    
    updateNetworkStatus();
    
    cacheManager.clear();
</script>

<!-- Banner Ad Container -->
<div id="bannerAdContainer">
    <script type="text/javascript">
        atOptions = {
            'key' : '4d607ded7910fca635b8c617cab0138b',
            'format' : 'iframe',
            'height' : 50,
            'width' : 320,
            'params' : {}
        };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/4d607ded7910fca635b8c617cab0138b/invoke.js"></script>
</div>

<!-- SOCIAL BAR AD PLACEMENT START -->
<script type='text/javascript' src='//pl27830601.effectivegatecpm.com/61/21/5c/61215cba46c6c0153fc2fb2a8eddc027.js'></script>
<!-- SOCIAL BAR AD PLACEMENT END -->

<!-- SERVICE WORKER REGISTRATION SCRIPT YAHAN PASTE KAREIN -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log(' ServiceWorker registered successfully: ', registration.scope);
        })
        .catch(error => {
          console.log(' ServiceWorker registration failed: ', error);
        });
    });
  }
</script>

</body>
</html>